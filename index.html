<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Malotes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Bibliotecas para exporta√ß√£o -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Estilos para impress√£o */
        @media print {
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%; 
                background: white;
                padding: 20px;
            }
            .no-print { display: none !important; }
            .print-header { 
                text-align: center; 
                margin-bottom: 30px; 
                border-bottom: 2px solid #333;
                padding-bottom: 15px;
            }
            table { 
                width: 100% !important; 
                border-collapse: collapse !important;
                font-size: 12px !important;
            }
            th, td { 
                border: 1px solid #333 !important; 
                padding: 8px !important;
                text-align: left !important;
            }
            th { 
                background-color: #f0f0f0 !important; 
                font-weight: bold !important;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Tela de Login -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Controle de Malotes</h1>
                <p class="text-gray-600">Fa√ßa login para continuar</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="text" id="loginEmail" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                    <input type="password" id="loginPassword" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <button type="submit" 
                        class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition duration-200 font-medium">
                    Entrar
                </button>
                
                <button type="button" onclick="showRegister()" 
                        class="w-full bg-gray-100 text-gray-700 py-3 rounded-lg hover:bg-gray-200 transition duration-200 font-medium">
                    Cadastrar Novo Usu√°rio
                </button>
            </form>
            
            <div id="loginMessage" class="mt-4 text-center text-red-600 hidden"></div>
        </div>
    </div>

    <!-- Tela de Cadastro -->
    <div id="registerScreen" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Cadastro</h1>
                <p class="text-gray-600">Crie sua conta</p>
            </div>
            
            <form id="registerForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome Completo</label>
                    <input type="text" id="registerName" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="registerEmail" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                    <input type="password" id="registerPassword" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Confirmar Senha</label>
                    <input type="password" id="confirmPassword" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <button type="submit" 
                        class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition duration-200 font-medium">
                    Cadastrar
                </button>
                
                <button type="button" onclick="showLogin()" 
                        class="w-full bg-gray-100 text-gray-700 py-3 rounded-lg hover:bg-gray-200 transition duration-200 font-medium">
                    Voltar ao Login
                </button>
            </form>
            
            <div id="registerMessage" class="mt-4 text-center hidden"></div>
        </div>
    </div>

    <!-- Tela Principal -->
    <div id="mainScreen" class="hidden min-h-screen">
        <!-- Menu Flutuante -->
        <div id="floatingMenu" class="fixed top-20 left-6 bg-gray-800 text-white rounded-xl shadow-2xl p-4 z-50 hidden">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-bold">Menu</h2>
                <button onclick="toggleFloatingMenu()" class="text-white hover:text-gray-300">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <nav class="space-y-2">
                <a href="#" onclick="showSection('malotes')" class="block py-2 px-3 rounded hover:bg-gray-700 transition text-sm">
                    <i class="fas fa-box mr-2"></i>Malotes
                </a>
                <a href="#" onclick="showSection('leituras')" class="block py-2 px-3 rounded hover:bg-gray-700 transition text-sm">
                    <i class="fas fa-barcode mr-2"></i>Leituras
                </a>
                <a href="#" onclick="showSection('cadeados')" class="block py-2 px-3 rounded hover:bg-gray-700 transition text-sm">
                    <i class="fas fa-lock mr-2"></i>Cadeados
                </a>
                <a href="#" onclick="showSection('lavagem')" class="block py-2 px-3 rounded hover:bg-gray-700 transition text-sm">
                    <i class="fas fa-soap mr-2"></i>Lavagem
                </a>
                <a href="#" onclick="showSection('troca')" class="block py-2 px-3 rounded hover:bg-gray-700 transition text-sm">
                    <i class="fas fa-exchange-alt mr-2"></i>Troca
                </a>
                <a href="#" onclick="showSection('filiais')" class="block py-2 px-3 rounded hover:bg-gray-700 transition text-sm">
                    <i class="fas fa-building mr-2"></i>Filiais
                </a>
                <a href="#" onclick="showSection('graficos')" class="block py-2 px-3 rounded hover:bg-gray-700 transition text-sm">
                    <i class="fas fa-chart-bar mr-2"></i>Relat√≥rios Gr√°ficos
                </a>
                <!-- Menu Admin - Vis√≠vel apenas para usu√°rio R -->
                <div id="adminMenuSection" class="hidden border-t border-gray-600 mt-2 pt-2">
                    <div class="text-xs text-gray-400 mb-2 px-3">ADMINISTRADOR</div>
                    <a href="#" onclick="showSection('usuarios')" class="block py-2 px-3 rounded hover:bg-gray-700 transition text-sm">
                        <i class="fas fa-users-cog mr-2"></i>Gerenciar Usu√°rios
                    </a>
                    <a href="#" onclick="showSection('whatsapp-config')" class="block py-2 px-3 rounded hover:bg-gray-700 transition text-sm">
                        <i class="fab fa-whatsapp mr-2"></i>Configurar WhatsApp
                    </a>
                </div>
            </nav>
        </div>

        <!-- Header -->
        <div class="bg-white shadow-lg">
            <div class="flex items-center justify-between p-4">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-gray-800">Controle de Malotes</h1>
                </div>
                <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition">
                    <i class="fas fa-sign-out-alt mr-2"></i>Sair
                </button>
            </div>
        </div>

        <!-- Conte√∫do Principal -->
        <div class="p-6">
            <!-- Se√ß√£o Malotes -->
            <div id="malotesSection" class="fade-in">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">Controle de Malotes</h2>
                    
                    <!-- Estoque Atual -->
                    <div class="bg-blue-50 p-4 rounded-lg mb-6">
                        <h3 class="text-lg font-semibold text-blue-800 mb-2">üì¶ Estoque Atual</h3>
                        <p class="text-2xl font-bold text-blue-600" id="malotesStock">0 malotes</p>
                    </div>
                    
                    <!-- Entrada de Malotes -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold text-green-800 mb-4">‚ûï Entrada de Malotes</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Quantidade</label>
                                    <input type="number" id="malotesEntrada" min="1" placeholder="Ex: 10" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                </div>
                                <button onclick="adicionarMalotes()" 
                                        class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition">
                                    Adicionar ao Estoque
                                </button>
                            </div>
                        </div>
                        
                        <!-- Troca de Malotes -->
                        <div class="bg-orange-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold text-orange-800 mb-4">üîÑ Troca de Malote</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cidade *</label>
                                    <input type="text" id="maloteCidade" placeholder="Ex: Campo Grande" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">N√∫mero do Malote *</label>
                                    <input type="text" id="maloteNumero" placeholder="Ex: M-001" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Motivo da Troca *</label>
                                    <input type="text" id="maloteMotivo" placeholder="Ex: Malote danificado" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                                </div>
                                <button onclick="trocarMalote()" 
                                        class="w-full bg-orange-600 text-white py-2 rounded-lg hover:bg-orange-700 transition">
                                    Registrar Troca
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hist√≥rico de Movimenta√ß√µes -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">üìã Hist√≥rico de Movimenta√ß√µes</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse bg-white">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">Tipo</th>
                                        <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">Quantidade</th>
                                        <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">Motivo</th>
                                        <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">Data</th>
                                    </tr>
                                </thead>
                                <tbody id="malotesHistorico">
                                    <!-- Dados ser√£o inseridos aqui -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Se√ß√£o Leituras -->
            <div id="leiturasSection" class="hidden fade-in">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <div class="mb-6">
                        <div id="greetingMessage" class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4 rounded-lg mb-4">
                            <h3 class="text-lg font-semibold">Carregando...</h3>
                        </div>
                        <h2 class="text-xl font-bold text-gray-800">Leitura de C√≥digos</h2>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Campo de Leitura (Digite manualmente ou use o leitor)</label>
                        <input type="text" id="barcodeInput" placeholder="Digite o c√≥digo ou escaneie com o leitor..." 
                               class="w-full px-4 py-3 border-2 border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg">
                        <p class="text-sm text-gray-600 mt-2">üí° Digite o c√≥digo e pressione Enter para registrar</p>
                        
                        <!-- √Årea de feedback -->
                        <div id="feedbackMessage" class="mt-3 p-3 rounded-lg hidden">
                            <span id="feedbackText"></span>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse bg-white">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">Filial</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">Tipo</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">Data</th>
                                </tr>
                            </thead>
                            <tbody id="malotesTable">
                                <!-- Dados ser√£o inseridos aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Outras se√ß√µes (placeholder) -->
            <div id="cadeadosSection" class="hidden fade-in">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">Controle de Cadeados</h2>
                    
                    <!-- Estoque Atual -->
                    <div class="bg-purple-50 p-4 rounded-lg mb-6">
                        <h3 class="text-lg font-semibold text-purple-800 mb-2">üîí Estoque Atual</h3>
                        <p class="text-2xl font-bold text-purple-600" id="cadeadosStock">0 cadeados</p>
                    </div>
                    
                    <!-- Entrada de Cadeados -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold text-green-800 mb-4">‚ûï Entrada de Cadeados</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Quantidade</label>
                                    <input type="number" id="cadeadosEntrada" min="1" placeholder="Ex: 15" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                </div>
                                <button onclick="adicionarCadeados()" 
                                        class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition">
                                    Adicionar ao Estoque
                                </button>
                            </div>
                        </div>
                        
                        <!-- Troca de Cadeados -->
                        <div class="bg-orange-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold text-orange-800 mb-4">üîÑ Troca de Cadeado</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cidade *</label>
                                    <input type="text" id="cadeadoCidade" placeholder="Ex: Dourados" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">N√∫mero do Cadeado *</label>
                                    <input type="text" id="cadeadoNumero" placeholder="Ex: C-001" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Motivo da Troca *</label>
                                    <input type="text" id="cadeadoMotivo" placeholder="Ex: Cadeado quebrado" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                                </div>
                                <button onclick="trocarCadeado()" 
                                        class="w-full bg-orange-600 text-white py-2 rounded-lg hover:bg-orange-700 transition">
                                    Registrar Troca
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hist√≥rico de Movimenta√ß√µes -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">üìã Hist√≥rico de Movimenta√ß√µes</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse bg-white">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">Tipo</th>
                                        <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">Quantidade</th>
                                        <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">Motivo</th>
                                        <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">Data</th>
                                    </tr>
                                </thead>
                                <tbody id="cadeadosHistorico">
                                    <!-- Dados ser√£o inseridos aqui -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="lavagemSection" class="hidden fade-in">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">Controle de Lavagem</h2>
                    
                    <!-- Registro de Lavagem -->
                    <div class="bg-cyan-50 p-4 rounded-lg mb-6">
                        <h3 class="text-lg font-semibold text-cyan-800 mb-4">üßº Registro de Lavagem</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cidade *</label>
                                <input type="text" id="lavagemCidade" placeholder="Ex: Campo Grande" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">N√∫mero *</label>
                                <input type="text" id="lavagemNumero" placeholder="Ex: L-001" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500">
                            </div>
                        </div>
                        <button onclick="registrarLavagem()" 
                                class="w-full mt-4 bg-cyan-600 text-white py-2 rounded-lg hover:bg-cyan-700 transition">
                            Registrar Lavagem
                        </button>
                    </div>
                    
                    <!-- Hist√≥rico de Lavagens -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">üìã Hist√≥rico de Lavagens</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse bg-white">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">Cidade</th>
                                        <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">N√∫mero</th>
                                        <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">Data</th>
                                    </tr>
                                </thead>
                                <tbody id="lavagemHistorico">
                                    <!-- Dados ser√£o inseridos aqui -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="trocaSection" class="hidden fade-in">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">üîÑ Registro de Trocas</h2>
                    <p class="text-gray-600 mb-6">Hist√≥rico de todas as trocas de malotes e cadeados realizadas</p>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse bg-white">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">Filial</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">Tipo</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">Troca</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">Motivo</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">Data</th>
                                </tr>
                            </thead>
                            <tbody id="trocasTable">
                                <!-- Dados ser√£o inseridos aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Se√ß√£o Filiais -->
            <div id="filiaisSection" class="hidden fade-in">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">üè¢ Controle de Filiais</h2>
                    
                    <!-- Filtros -->
                    <div class="bg-gray-50 p-6 rounded-lg mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Filtros</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <!-- Filtro por Status -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status de Leitura</label>
                                <select id="statusFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onchange="filterFiliais()">
                                    <option value="">Todas as filiais</option>
                                    <option value="lidas">Filiais com leituras</option>
                                    <option value="nao-lidas">Filiais sem leituras</option>
                                </select>
                            </div>
                            
                            <!-- Filtro por Tipo -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Opera√ß√£o</label>
                                <select id="tipoFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onchange="filterFiliais()">
                                    <option value="">Todos os tipos</option>
                                    <option value="cargas">Cargas</option>
                                    <option value="passagens">Passagens</option>
                                </select>
                            </div>
                            
                            <!-- Filtro por Per√≠odo -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Per√≠odo de An√°lise</label>
                                <select id="periodoFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onchange="filterFiliais()">
                                    <option value="hoje">Hoje</option>
                                    <option value="semana">Esta semana</option>
                                    <option value="mes" selected>Este m√™s</option>
                                    <option value="todos">Todos os tempos</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Busca por nome -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Buscar por nome da filial</label>
                            <input type="text" id="searchFilial" placeholder="Digite o nome da filial..." 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   oninput="filterFiliais()">
                        </div>
                        
                        <!-- Bot√µes de a√ß√£o -->
                        <div class="flex flex-wrap gap-3">
                            <button onclick="clearFilters()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition">
                                <i class="fas fa-eraser mr-2"></i>Limpar Filtros
                            </button>
                            <button onclick="sendWhatsAppToUnread()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                                <i class="fab fa-whatsapp mr-2"></i>Enviar WhatsApp para Filiais Sem Leitura Hoje
                            </button>
                        </div>
                    </div>
                    
                    <!-- Resumo -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-blue-600" id="totalFiliais">0</div>
                            <div class="text-sm text-blue-800">Total de Filiais</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-green-600" id="filiaisLidas">0</div>
                            <div class="text-sm text-green-800">Com Leituras</div>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-red-600" id="filiaisNaoLidas">0</div>
                            <div class="text-sm text-red-800">Sem Leituras</div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-purple-600" id="percentualLeituras">0%</div>
                            <div class="text-sm text-purple-800">Taxa de Leitura</div>
                        </div>
                    </div>
                    
                    <!-- Lista de Filiais -->
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse bg-white">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">
                                        <i class="fas fa-building mr-2"></i>Filial
                                    </th>
                                    <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">
                                        <i class="fas fa-tag mr-2"></i>Tipo
                                    </th>
                                    <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">
                                        <i class="fas fa-check-circle mr-2"></i>Status
                                    </th>
                                    <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">
                                        <i class="fas fa-calendar mr-2"></i>√öltima Leitura
                                    </th>
                                    <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">
                                        <i class="fas fa-hashtag mr-2"></i>Total de Leituras
                                    </th>
                                    <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">
                                        <i class="fab fa-whatsapp mr-2"></i>WhatsApp
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="filiaisTable">
                                <!-- Dados ser√£o inseridos aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Se√ß√£o Gerenciar Usu√°rios (Admin) -->
            <div id="usuariosSection" class="hidden fade-in">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">üë• Gerenciar Usu√°rios</h2>
                    
                    <!-- Adicionar Novo Usu√°rio -->
                    <div class="bg-green-50 p-6 rounded-lg mb-6">
                        <h3 class="text-lg font-semibold text-green-800 mb-4">‚ûï Adicionar Novo Usu√°rio</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nome Completo *</label>
                                <input type="text" id="newUserName" placeholder="Ex: Jo√£o Silva" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Email/Login *</label>
                                <input type="text" id="newUserEmail" placeholder="Ex: joao@empresa.com" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Senha *</label>
                                <input type="password" id="newUserPassword" placeholder="Digite a senha" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                            </div>
                        </div>
                        <button onclick="addNewUser()" 
                                class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition">
                            <i class="fas fa-user-plus mr-2"></i>Adicionar Usu√°rio
                        </button>
                    </div>
                    
                    <!-- Lista de Usu√°rios -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">üìã Usu√°rios Cadastrados</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse bg-white">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">Nome</th>
                                        <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">Email/Login</th>
                                        <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">Tipo</th>
                                        <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="usuariosTable">
                                    <!-- Dados ser√£o inseridos aqui -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Se√ß√£o Configurar WhatsApp (Admin) -->
            <div id="whatsapp-configSection" class="hidden fade-in">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">üì± Configurar WhatsApp das Filiais</h2>
                    
                    <!-- Filtros -->
                    <div class="bg-gray-50 p-4 rounded-lg mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Buscar Filial</label>
                                <input type="text" id="searchWhatsAppFilial" placeholder="Digite o nome da filial..." 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                       oninput="filterWhatsAppFiliais()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Filtrar por Tipo</label>
                                <select id="whatsappTipoFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onchange="filterWhatsAppFiliais()">
                                    <option value="">Todos os tipos</option>
                                    <option value="cargas">Cargas</option>
                                    <option value="passagens">Passagens</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Lista de Filiais para Editar WhatsApp -->
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse bg-white">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">Filial</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">Tipo</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">WhatsApp Atual</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">Novo WhatsApp</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="whatsappConfigTable">
                                <!-- Dados ser√£o inseridos aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="graficosSection" class="hidden fade-in">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">üìä Relat√≥rios Gr√°ficos</h2>
                    
                    <!-- Filtros -->
                    <div class="bg-gray-50 p-6 rounded-lg mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Filtros do Relat√≥rio</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                            <!-- Tipo de Relat√≥rio -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Relat√≥rio *</label>
                                <select id="reportType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onchange="updateReportFilters()">
                                    <option value="">Selecione o tipo</option>
                                    <option value="malotes">Relat√≥rio de Malotes (Leituras)</option>
                                    <option value="lavagem">Relat√≥rio de Lavagem</option>
                                    <option value="troca">Relat√≥rio de Trocas</option>
                                </select>
                            </div>
                            
                            <!-- Subtipo (para trocas) -->
                            <div id="subTypeDiv" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Troca *</label>
                                <select id="subType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">Todos</option>
                                    <option value="malote">Malote</option>
                                    <option value="cadeado">Cadeado</option>
                                </select>
                            </div>
                            
                            <!-- Tipo de Opera√ß√£o -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Opera√ß√£o</label>
                                <select id="operationType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">Todos</option>
                                    <option value="cargas">Cargas</option>
                                    <option value="passagens">Passagens</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <!-- Data Inicial -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Data Inicial *</label>
                                <input type="date" id="reportStartDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            
                            <!-- Data Final -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Data Final *</label>
                                <input type="date" id="reportEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        
                        <!-- Filtro por Filial -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filtrar por Filial</label>
                            <select id="reportFilialFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">Todas as filiais</option>
                            </select>
                        </div>
                        
                        <!-- Bot√£o Gerar -->
                        <button onclick="generateGraphicReport()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition font-medium">
                            <i class="fas fa-chart-bar mr-2"></i>Gerar Relat√≥rio
                        </button>
                    </div>
                    
                    <!-- Resultados -->
                    <div id="reportGraphicResults" class="hidden">
                        <!-- Resumo -->
                        <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-6 rounded-lg mb-6">
                            <h4 class="text-xl font-bold mb-2">üìà Resumo do Relat√≥rio</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="text-center">
                                    <div class="text-2xl font-bold" id="totalRecords">0</div>
                                    <div class="text-sm opacity-90">Total de Registros</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold" id="totalCargas">0</div>
                                    <div class="text-sm opacity-90">Cargas</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold" id="totalPassagens">0</div>
                                    <div class="text-sm opacity-90">Passagens</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Gr√°fico por Filial -->
                        <div class="bg-white border rounded-lg p-6 mb-6">
                            <h4 class="text-lg font-bold text-gray-800 mb-4">üìä Distribui√ß√£o por Filial</h4>
                            <div id="filialChart" class="h-64 flex items-end justify-center space-x-2 bg-gray-50 rounded-lg p-4">
                                <!-- Gr√°fico ser√° inserido aqui -->
                            </div>
                        </div>
                        
                        <!-- Gr√°fico por Tipo -->
                        <div class="bg-white border rounded-lg p-6 mb-6">
                            <h4 class="text-lg font-bold text-gray-800 mb-4">üîÑ Distribui√ß√£o por Tipo</h4>
                            <div id="typeChart" class="h-64 flex items-center justify-center space-x-8 bg-gray-50 rounded-lg p-4">
                                <!-- Gr√°fico ser√° inserido aqui -->
                            </div>
                        </div>
                        
                        <!-- Tabela Detalhada -->
                        <div class="bg-white border rounded-lg p-6">
                            <h4 class="text-lg font-bold text-gray-800 mb-4">üìã Dados Detalhados</h4>
                            <div class="overflow-x-auto">
                                <table class="w-full border-collapse">
                                    <thead>
                                        <tr class="bg-gray-50">
                                            <th class="border border-gray-300 px-3 py-2 text-left text-sm font-semibold">Filial</th>
                                            <th class="border border-gray-300 px-3 py-2 text-left text-sm font-semibold">Tipo</th>
                                            <th class="border border-gray-300 px-3 py-2 text-left text-sm font-semibold" id="dynamicColumn">Info</th>
                                            <th class="border border-gray-300 px-3 py-2 text-left text-sm font-semibold">Data</th>
                                        </tr>
                                    </thead>
                                    <tbody id="reportDetailTable">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Bot√µes de Exporta√ß√£o -->
                        <div class="mt-6 flex flex-wrap justify-center gap-4">
                            <button onclick="exportToExcel()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition font-medium">
                                <i class="fas fa-file-excel mr-2"></i>Exportar Excel
                            </button>
                            <button onclick="exportToPDF()" class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition font-medium">
                                <i class="fas fa-file-pdf mr-2"></i>Exportar PDF
                            </button>
                            <button onclick="printReport()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition font-medium">
                                <i class="fas fa-print mr-2"></i>Imprimir
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Bot√µes flutuantes -->
        <button onclick="toggleFloatingMenu()" class="fixed top-20 left-6 bg-gray-800 text-white p-3 rounded-full shadow-lg hover:bg-gray-700 transition-all duration-200 hover:scale-110 z-40">
            <i class="fas fa-bars text-lg"></i>
        </button>
        
        <button id="reportButton" onclick="showReportModal()" class="fixed top-32 right-6 bg-blue-500 text-white p-4 rounded-full shadow-lg hover:bg-blue-600 transition-all duration-200 hover:scale-110 z-30 hidden">
            <i class="fas fa-filter text-xl"></i>
        </button>
    </div>

    <!-- Modal de Relat√≥rios -->
    <div id="reportModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold text-gray-800">Gerar Relat√≥rio</h3>
                    <button onclick="closeReportModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Data Inicial</label>
                        <input type="date" id="startDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Data Final</label>
                        <input type="date" id="endDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Filtrar por Filial</label>
                    <select id="filialFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Todas as filiais</option>
                    </select>
                </div>
                
                <button onclick="generateReport()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition font-medium">
                    Gerar Relat√≥rio
                </button>
                
                <div id="reportResults" class="mt-6 hidden">
                    <h4 class="font-bold text-gray-800 mb-4">Resultados:</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-300 px-3 py-2 text-left text-sm font-semibold">Filial</th>
                                    <th class="border border-gray-300 px-3 py-2 text-left text-sm font-semibold">Tipo</th>
                                    <th class="border border-gray-300 px-3 py-2 text-left text-sm font-semibold">Data</th>
                                </tr>
                            </thead>
                            <tbody id="reportTable">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, where, Timestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAN9oA35wYaSTKnIOpWXrwp3G9xfIkHc80",
            authDomain: "controle-de-malotes.firebaseapp.com",
            projectId: "controle-de-malotes",
            storageBucket: "controle-de-malotes.firebasestorage.app",
            messagingSenderId: "375813159120",
            appId: "1:375813159120:web:2f2210b9caf5b4079d86d5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Torna as fun√ß√µes do Firebase dispon√≠veis globalmente
        window.firebaseDB = {
            addUser: async (user) => {
                try {
                    await addDoc(collection(db, "users"), user);
                    return true;
                } catch (error) {
                    console.error("Erro ao adicionar usu√°rio:", error);
                    return false;
                }
            },

            getUsers: async () => {
                try {
                    const querySnapshot = await getDocs(collection(db, "users"));
                    const users = [];
                    querySnapshot.forEach((doc) => {
                        users.push({ id: doc.id, ...doc.data() });
                    });
                    return users;
                } catch (error) {
                    console.error("Erro ao buscar usu√°rios:", error);
                    return [];
                }
            },

            addLeitura: async (leitura) => {
                try {
                    await addDoc(collection(db, "leituras"), {
                        ...leitura,
                        timestamp: Timestamp.now()
                    });
                    return true;
                } catch (error) {
                    console.error("Erro ao adicionar leitura:", error);
                    return false;
                }
            },

            getLeituras: async () => {
                try {
                    const q = query(collection(db, "leituras"), orderBy("timestamp", "desc"));
                    const querySnapshot = await getDocs(q);
                    const leituras = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        leituras.push({
                            id: doc.id,
                            ...data,
                            timestamp: data.timestamp.toMillis()
                        });
                    });
                    return leituras;
                } catch (error) {
                    console.error("Erro ao buscar leituras:", error);
                    return [];
                }
            },

            getLeiturasFiltered: async (startDate, endDate, filialFilter) => {
                try {
                    let q = query(collection(db, "leituras"), orderBy("timestamp", "desc"));
                    
                    if (startDate && endDate) {
                        // Garante que o endDate inclua todo o √∫ltimo dia
                        const adjustedEndDate = new Date(endDate);
                        adjustedEndDate.setHours(23, 59, 59, 999);
                        
                        const start = Timestamp.fromDate(startDate);
                        const end = Timestamp.fromDate(adjustedEndDate);
                        q = query(collection(db, "leituras"), 
                                where("timestamp", ">=", start),
                                where("timestamp", "<=", end),
                                orderBy("timestamp", "desc"));
                    }
                    
                    const querySnapshot = await getDocs(q);
                    let leituras = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        leituras.push({
                            id: doc.id,
                            ...data,
                            timestamp: data.timestamp.toMillis()
                        });
                    });
                    
                    if (filialFilter) {
                        leituras = leituras.filter(l => normalizeText(l.filial).includes(normalizeText(filialFilter)));
                    }
                    
                    return leituras;
                } catch (error) {
                    console.error("Erro ao buscar leituras filtradas:", error);
                    return [];
                }
            },

            // Fun√ß√µes para Malotes
            addMaloteMovimento: async (movimento) => {
                try {
                    await addDoc(collection(db, "malotes"), {
                        ...movimento,
                        timestamp: Timestamp.now()
                    });
                    return true;
                } catch (error) {
                    console.error("Erro ao adicionar movimento de malote:", error);
                    return false;
                }
            },

            getMaloteMovimentos: async () => {
                try {
                    const q = query(collection(db, "malotes"), orderBy("timestamp", "desc"));
                    const querySnapshot = await getDocs(q);
                    const movimentos = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        movimentos.push({
                            id: doc.id,
                            ...data,
                            timestamp: data.timestamp.toMillis()
                        });
                    });
                    return movimentos;
                } catch (error) {
                    console.error("Erro ao buscar movimentos de malotes:", error);
                    return [];
                }
            },

            // Fun√ß√µes para Cadeados
            addCadeadoMovimento: async (movimento) => {
                try {
                    await addDoc(collection(db, "cadeados"), {
                        ...movimento,
                        timestamp: Timestamp.now()
                    });
                    return true;
                } catch (error) {
                    console.error("Erro ao adicionar movimento de cadeado:", error);
                    return false;
                }
            },

            getCadeadoMovimentos: async () => {
                try {
                    const q = query(collection(db, "cadeados"), orderBy("timestamp", "desc"));
                    const querySnapshot = await getDocs(q);
                    const movimentos = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        movimentos.push({
                            id: doc.id,
                            ...data,
                            timestamp: data.timestamp.toMillis()
                        });
                    });
                    return movimentos;
                } catch (error) {
                    console.error("Erro ao buscar movimentos de cadeados:", error);
                    return [];
                }
            },

            // Fun√ß√µes para Trocas
            addTroca: async (troca) => {
                try {
                    await addDoc(collection(db, "trocas"), {
                        ...troca,
                        timestamp: Timestamp.now()
                    });
                    return true;
                } catch (error) {
                    console.error("Erro ao adicionar troca:", error);
                    return false;
                }
            },

            getTrocas: async () => {
                try {
                    const q = query(collection(db, "trocas"), orderBy("timestamp", "desc"));
                    const querySnapshot = await getDocs(q);
                    const trocas = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        trocas.push({
                            id: doc.id,
                            ...data,
                            timestamp: data.timestamp.toMillis()
                        });
                    });
                    return trocas;
                } catch (error) {
                    console.error("Erro ao buscar trocas:", error);
                    return [];
                }
            },

            // Fun√ß√µes para Lavagem
            addLavagem: async (lavagem) => {
                try {
                    await addDoc(collection(db, "lavagem"), {
                        ...lavagem,
                        timestamp: Timestamp.now()
                    });
                    return true;
                } catch (error) {
                    console.error("Erro ao adicionar lavagem:", error);
                    return false;
                }
            },

            getLavagens: async () => {
                try {
                    const q = query(collection(db, "lavagem"), orderBy("timestamp", "desc"));
                    const querySnapshot = await getDocs(q);
                    const lavagens = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        lavagens.push({
                            id: doc.id,
                            ...data,
                            timestamp: data.timestamp.toMillis()
                        });
                    });
                    return lavagens;
                } catch (error) {
                    console.error("Erro ao buscar lavagens:", error);
                    return [];
                }
            }
        };

        // Inicializa os usu√°rios padr√£o
        window.initializeDefaultUser = async () => {
            try {
                const users = await window.firebaseDB.getUsers();
                
                // Usu√°rio administrador R
                const adminExists = users.find(u => normalizeText(u.email) === normalizeText('R'));
                if (!adminExists) {
                    await window.firebaseDB.addUser({
                        name: 'Administrador',
                        email: 'R',
                        password: 'R'
                    });
                    console.log('Usu√°rio administrador R criado');
                }
                
                // Usu√°rio de teste Y
                const testUserExists = users.find(u => normalizeText(u.email) === normalizeText('Y'));
                if (!testUserExists) {
                    await window.firebaseDB.addUser({
                        name: 'Usu√°rio Teste',
                        email: 'Y',
                        password: 'Y'
                    });
                    console.log('Usu√°rio de teste Y criado');
                }
            } catch (error) {
                console.log('Erro ao inicializar usu√°rios padr√£o:', error);
                // Continua mesmo com erro
            }
        };

        // Chama a inicializa√ß√£o quando o Firebase estiver pronto
        setTimeout(() => {
            window.initializeDefaultUser();
        }, 1000);
    </script>

    <script>
        // Dados das filiais (mantido local por ser est√°tico)
        const filiais = [
            // === PASSAGENS ===
            // Alcin√≥polis - separado
            { codigo: 'Alcin√≥polis-4', tipo: 'passagens', whatsapp: '67999000001' },
            { codigo: 'Alcin√≥polis-06', tipo: 'passagens', whatsapp: '67999000002' },
            
            // Amamba√≠
            { codigo: 'Amamba√≠-8', tipo: 'passagens', whatsapp: '67999000003' },
            
            // Anast√°cio - separado
            { codigo: 'Anast√°cio-247', tipo: 'passagens', whatsapp: '67999000004' },
            { codigo: 'Anast√°cio-265', tipo: 'passagens', whatsapp: '67999000005' },
            
            // Ant√¥nio Jo√£o - separado
            { codigo: 'Ant√¥nio Jo√£o-263', tipo: 'passagens', whatsapp: '67999000006' },
            { codigo: 'Ant√¥nio Jo√£o-297', tipo: 'passagens', whatsapp: '67999000007' },
            
            // Aquidauana - separado
            { codigo: 'Aquidauana-199', tipo: 'passagens', whatsapp: '67999000008' },
            { codigo: 'Aquidauana-200', tipo: 'passagens', whatsapp: '67999000009' },
            
            // Bandeirantes - separado
            { codigo: 'Bandeirantes-303', tipo: 'passagens', whatsapp: '67999000010' },
            { codigo: 'Bandeirantes-304', tipo: 'passagens', whatsapp: '67999000011' },
            
            // Bela Vista - separado
            { codigo: 'Bela Vista-37', tipo: 'passagens', whatsapp: '67999000012' },
            { codigo: 'Bela Vista-02', tipo: 'passagens', whatsapp: '67999000013' },
            
            // Bodoquena - separado
            { codigo: 'Bodoquena-40', tipo: 'passagens', whatsapp: '67999000014' },
            { codigo: 'Bodoquena-268', tipo: 'passagens', whatsapp: '67999000015' },
            
            // Bonito - separado
            { codigo: 'Bonito-44', tipo: 'passagens', whatsapp: '67999000016' },
            { codigo: 'Bonito-45', tipo: 'passagens', whatsapp: '67999000017' },
            
            // Caarap√≥ - separado
            { codigo: 'Caarap√≥-8', tipo: 'passagens', whatsapp: '67999000018' },
            { codigo: 'Caarap√≥-09', tipo: 'passagens', whatsapp: '67999000019' },
            
            // Camapu√£ - separado
            { codigo: 'Camapu√£-270', tipo: 'passagens', whatsapp: '67999000020' },
            { codigo: 'Camapu√£-271', tipo: 'passagens', whatsapp: '67999000021' },
            
            // Caracol - separado
            { codigo: 'Caracol-58', tipo: 'passagens', whatsapp: '67999000022' },
            { codigo: 'Caracol-59', tipo: 'passagens', whatsapp: '67999000023' },
            
            // Cassil√¢ndia - separado
            { codigo: 'Cassil√¢ndia-98', tipo: 'passagens', whatsapp: '67999000024' },
            { codigo: 'Cassil√¢ndia-99', tipo: 'passagens', whatsapp: '67999000025' },
            
            // Cel Antonino - separado
            { codigo: 'Cel Antonino-295', tipo: 'passagens', whatsapp: '67999000026' },
            { codigo: 'Cel Antonino-296', tipo: 'passagens', whatsapp: '67999000027' },
            
            // Chapad√£o do Sul - separado
            { codigo: 'Chapad√£o do Sul-60', tipo: 'passagens', whatsapp: '67999000028' },
            { codigo: 'Chapad√£o do Sul-61', tipo: 'passagens', whatsapp: '67999000029' },
            
            // Corguinho - separado
            { codigo: 'Corguinho-67', tipo: 'passagens', whatsapp: '67999000030' },
            { codigo: 'Corguinho-68', tipo: 'passagens', whatsapp: '67999000031' },
            
            // Coronel Sapucaia
            { codigo: 'Coronel Sapucaia-279', tipo: 'passagens', whatsapp: '67999000032' },
            
            // Corumb√°
            { codigo: 'Corumb√°-61', tipo: 'passagens', whatsapp: '67999000033' },
            
            // Costa Rica
            { codigo: 'Costa Rica-222', tipo: 'passagens', whatsapp: '67999000034' },
            
            // Dourados - separado
            { codigo: 'Dourados-87', tipo: 'passagens', whatsapp: '67999000035' },
            { codigo: 'Dourados-85', tipo: 'passagens', whatsapp: '67999000036' },
            
            // Figueir√£o - separado
            { codigo: 'Figueir√£o-94', tipo: 'passagens', whatsapp: '67999000037' },
            { codigo: 'Figueir√£o-95', tipo: 'passagens', whatsapp: '67999000038' },
            
            // Guia Lopes
            { codigo: 'Guia Lopes-100', tipo: 'passagens', whatsapp: '67999000039' },
            
            // Imbirussu - separado
            { codigo: 'Imbirussu-300', tipo: 'passagens', whatsapp: '67999000040' },
            { codigo: 'Imbirussu-301', tipo: 'passagens', whatsapp: '67999000041' },
            
            // Jardim - separado
            { codigo: 'Jardim-115', tipo: 'passagens', whatsapp: '67999000042' },
            { codigo: 'Jardim-116', tipo: 'passagens', whatsapp: '67999000043' },
            { codigo: 'Jardim-117', tipo: 'passagens', whatsapp: '67999000044' },
            { codigo: 'Jardim-118', tipo: 'passagens', whatsapp: '67999000045' },
            
            // Manoel Taveira - separado
            { codigo: 'Manoel Taveira-297', tipo: 'passagens', whatsapp: '67999000046' },
            { codigo: 'Manoel Taveira-298', tipo: 'passagens', whatsapp: '67999000047' },
            
            // Maracaju - separado
            { codigo: 'Maracaju-280', tipo: 'passagens', whatsapp: '67999000048' },
            { codigo: 'Maracaju-127', tipo: 'passagens', whatsapp: '67999000049' },
            { codigo: 'Maracaju-128', tipo: 'passagens', whatsapp: '67999000050' },
            { codigo: 'Maracaju-129', tipo: 'passagens', whatsapp: '67999000051' },
            
            // Nioaque - separado
            { codigo: 'Nioaque-144', tipo: 'passagens', whatsapp: '67999000052' },
            { codigo: 'Nioaque-282', tipo: 'passagens', whatsapp: '67999000053' },
            
            // Nova Alvorada do Sul - separado
            { codigo: 'Nova Alvorada do Sul-147', tipo: 'passagens', whatsapp: '67999000054' },
            { codigo: 'Nova Alvorada do Sul-146', tipo: 'passagens', whatsapp: '67999000055' },
            
            // Paranhos - separado
            { codigo: 'Paranhos-601', tipo: 'passagens', whatsapp: '67999000056' },
            { codigo: 'Paranhos-602', tipo: 'passagens', whatsapp: '67999000057' },
            
            // Ponta Por√£ - separado
            { codigo: 'Ponta Por√£-232', tipo: 'passagens', whatsapp: '67999000058' },
            { codigo: 'Ponta Por√£-233', tipo: 'passagens', whatsapp: '67999000059' },
            
            // Porto Murtinho - separado
            { codigo: 'Porto Murtinho-208', tipo: 'passagens', whatsapp: '67999000060' },
            { codigo: 'Porto Murtinho-209', tipo: 'passagens', whatsapp: '67999000061' },
            
            // Rio Brilhante - separado
            { codigo: 'Rio Brilhante-237', tipo: 'passagens', whatsapp: '67999000062' },
            { codigo: 'Rio Brilhante-284', tipo: 'passagens', whatsapp: '67999000063' },
            
            // Rio Negro - separado
            { codigo: 'Rio Negro-163', tipo: 'passagens', whatsapp: '67999000064' },
            { codigo: 'Rio Negro-164', tipo: 'passagens', whatsapp: '67999000065' },
            
            // Rochedo - separado
            { codigo: 'Rochedo-3', tipo: 'passagens', whatsapp: '67999000066' },
            { codigo: 'Rochedo-04', tipo: 'passagens', whatsapp: '67999000067' },
            
            // Rodovi√°ria
            { codigo: 'Rodovi√°ria-215', tipo: 'passagens', whatsapp: '67999000068' },
            
            // Sidrol√¢ndia
            { codigo: 'Sidrol√¢ndia-181', tipo: 'passagens', whatsapp: '67999000069' },

            // === CARGAS ===
            // 14 de julho - separado
            { codigo: '14 de julho-292', tipo: 'cargas', whatsapp: '67999000070' },
            { codigo: '14 de julho-293', tipo: 'cargas', whatsapp: '67999000071' },
            
            // ADM
            { codigo: 'ADM-34', tipo: 'cargas', whatsapp: '67999000072' },
            
            // √Ågua Clara - separado
            { codigo: '√Ågua Clara-290', tipo: 'cargas', whatsapp: '67999000073' },
            { codigo: '√Ågua Clara-02', tipo: 'cargas', whatsapp: '67984837813' },
            
            // Amamba√≠ - separado
            { codigo: 'Amamba√≠-9', tipo: 'cargas', whatsapp: '67999000075' },
            { codigo: 'Amamba√≠-07', tipo: 'cargas', whatsapp: '67999000076' },
            
            // Anauril√¢ndia - separado
            { codigo: 'Anauril√¢ndia-10', tipo: 'cargas', whatsapp: '67999000077' },
            { codigo: 'Anauril√¢ndia-11', tipo: 'cargas', whatsapp: '67999000078' },
            
            // Ant√¥nio Jo√£o
            { codigo: 'Ant√¥nio Jo√£o-297', tipo: 'cargas', whatsapp: '67999000079' },
            
            // Ap do Taboado - separado
            { codigo: 'Ap do Taboado-3', tipo: 'cargas', whatsapp: '67999000080' },
            { codigo: 'Ap do Taboado-04', tipo: 'cargas', whatsapp: '67999000081' },
            
            // Aquidauana - separado
            { codigo: 'Aquidauana-19', tipo: 'cargas', whatsapp: '67999000082' },
            { codigo: 'Aquidauana-20', tipo: 'cargas', whatsapp: '67999000083' },
            
            // Ara√ßatuba - separado
            { codigo: 'Ara√ßatuba-228', tipo: 'cargas', whatsapp: '67999000084' },
            { codigo: 'Ara√ßatuba-229', tipo: 'cargas', whatsapp: '67999000085' },
            
            // Arapongas
            { codigo: 'Arapongas-610', tipo: 'cargas', whatsapp: '67999000086' },
            
            // Bataguassu - separado
            { codigo: 'Bataguassu-31', tipo: 'cargas', whatsapp: '67999000087' },
            { codigo: 'Bataguassu-32', tipo: 'cargas', whatsapp: '67999000088' },
            
            // Bataipor√£ - separado
            { codigo: 'Bataipor√£-30', tipo: 'cargas', whatsapp: '67999000089' },
            { codigo: 'Bataipor√£-31', tipo: 'cargas', whatsapp: '67999000090' },
            
            // Brasil√¢ndia - separado
            { codigo: 'Brasil√¢ndia-35', tipo: 'cargas', whatsapp: '67999000091' },
            { codigo: 'Brasil√¢ndia-34', tipo: 'cargas', whatsapp: '67999000092' },
            
            // Brusque
            { codigo: 'Brusque-520', tipo: 'cargas', whatsapp: '67999000093' },
            
            // Caarap√≥ - separado
            { codigo: 'Caarap√≥-269', tipo: 'cargas', whatsapp: '67999000094' },
            { codigo: 'Caarap√≥-46', tipo: 'cargas', whatsapp: '67999000095' },
            
            // Cassil√¢ndia - separado
            { codigo: 'Cassil√¢ndia-55', tipo: 'cargas', whatsapp: '67999000096' },
            { codigo: 'Cassil√¢ndia-56', tipo: 'cargas', whatsapp: '67999000097' },
            
            // Chapad√£o do Sul - separado
            { codigo: 'Chapad√£o do Sul-65', tipo: 'cargas', whatsapp: '67999000098' },
            { codigo: 'Chapad√£o do Sul-66', tipo: 'cargas', whatsapp: '67999000099' },
            
            // Cianorte
            { codigo: 'Cianorte-1', tipo: 'cargas', whatsapp: '67999000100' },
            
            // Corumb√° - separado
            { codigo: 'Corumb√°-4', tipo: 'cargas', whatsapp: '67999000101' },
            { codigo: 'Corumb√°-71', tipo: 'cargas', whatsapp: '67999000102' },
            
            // Costa Rica - separado
            { codigo: 'Costa Rica-312', tipo: 'cargas', whatsapp: '67999000103' },
            { codigo: 'Costa Rica-313', tipo: 'cargas', whatsapp: '67999000104' },
            
            // Coxim - separado
            { codigo: 'Coxim-205', tipo: 'cargas', whatsapp: '67999000105' },
            { codigo: 'Coxim-206', tipo: 'cargas', whatsapp: '67999000106' },
            
            // Deod√°polis - separado
            { codigo: 'Deod√°polis-1', tipo: 'cargas', whatsapp: '67999000107' },
            { codigo: 'Deod√°polis-07', tipo: 'cargas', whatsapp: '67999000108' },
            
            // Dourados - separado
            { codigo: 'Dourados-82', tipo: 'cargas', whatsapp: '67999000109' },
            { codigo: 'Dourados-83', tipo: 'cargas', whatsapp: '67999000110' },
            
            // Eldorado - separado
            { codigo: 'Eldorado-88', tipo: 'cargas', whatsapp: '67999000111' },
            { codigo: 'Eldorado-89', tipo: 'cargas', whatsapp: '67999000112' },
            
            // F√°tima do Sul - separado
            { codigo: 'F√°tima do Sul-211', tipo: 'cargas', whatsapp: '67999000113' },
            { codigo: 'F√°tima do Sul-02', tipo: 'cargas', whatsapp: '67999000114' },
            
            // Gl√≥ria de Dourados - separado
            { codigo: 'Gl√≥ria de Dourados-98', tipo: 'cargas', whatsapp: '67999000115' },
            { codigo: 'Gl√≥ria de Dourados-276', tipo: 'cargas', whatsapp: '67999000116' },
            
            // Iguatemi - separado
            { codigo: 'Iguatemi-333', tipo: 'cargas', whatsapp: '67999000117' },
            { codigo: 'Iguatemi-334', tipo: 'cargas', whatsapp: '67999000118' },
            
            // Inoc√™ncia - separado
            { codigo: 'Inoc√™ncia-223', tipo: 'cargas', whatsapp: '67999000119' },
            { codigo: 'Inoc√™ncia-224', tipo: 'cargas', whatsapp: '67999000120' },
            
            // Itapor√£ - separado
            { codigo: 'Itapor√£-111', tipo: 'cargas', whatsapp: '67999000121' },
            { codigo: 'Itapor√£-110', tipo: 'cargas', whatsapp: '67999000122' },
            
            // Itaquira√≠ - separado
            { codigo: 'Itaquira√≠-107', tipo: 'cargas', whatsapp: '67999000123' },
            { codigo: 'Itaquira√≠-108', tipo: 'cargas', whatsapp: '67999000124' },
            
            // Ivinhema - separado
            { codigo: 'Ivinhema-113', tipo: 'cargas', whatsapp: '67999000125' },
            { codigo: 'Ivinhema-112', tipo: 'cargas', whatsapp: '67999000126' },
            
            // Juti - separado
            { codigo: 'Juti-1', tipo: 'cargas', whatsapp: '67999000127' },
            { codigo: 'Juti-02', tipo: 'cargas', whatsapp: '67999000128' },
            
            // Loanda
            { codigo: 'Loanda-1', tipo: 'cargas', whatsapp: '67999000129' },
            
            // Miranda - separado
            { codigo: 'Miranda-35', tipo: 'cargas', whatsapp: '67999000130' },
            { codigo: 'Miranda-36', tipo: 'cargas', whatsapp: '67999000131' },
            
            // Mundo Novo - separado
            { codigo: 'Mundo Novo-211', tipo: 'cargas', whatsapp: '67999000132' },
            { codigo: 'Mundo Novo-212', tipo: 'cargas', whatsapp: '67999000133' },
            
            // Navira√≠ - separado
            { codigo: 'Navira√≠-281', tipo: 'cargas', whatsapp: '67999000134' },
            { codigo: 'Navira√≠-140', tipo: 'cargas', whatsapp: '67999000135' },
            
            // Nova Alvorada - separado
            { codigo: 'Nova Alvorada-163', tipo: 'cargas', whatsapp: '67999000136' },
            { codigo: 'Nova Alvorada-164', tipo: 'cargas', whatsapp: '67999000137' },
            
            // Nova Andradina - separado
            { codigo: 'Nova Andradina-137', tipo: 'cargas', whatsapp: '67999000138' },
            { codigo: 'Nova Andradina-136', tipo: 'cargas', whatsapp: '67999000139' },
            
            // Para√≠so das √Åguas - separado
            { codigo: 'Para√≠so das √Åguas-217', tipo: 'cargas', whatsapp: '67999000140' },
            { codigo: 'Para√≠so das √Åguas-218', tipo: 'cargas', whatsapp: '67999000141' },
            
            // Parana√≠ba - separado
            { codigo: 'Parana√≠ba-148', tipo: 'cargas', whatsapp: '67999000142' },
            { codigo: 'Parana√≠ba-149', tipo: 'cargas', whatsapp: '67999000143' },
            { codigo: 'Parana√≠ba-150', tipo: 'cargas', whatsapp: '67999000144' },
            
            // Pedro Gomes - separado
            { codigo: 'Pedro Gomes-1', tipo: 'cargas', whatsapp: '67999000145' },
            { codigo: 'Pedro Gomes-02', tipo: 'cargas', whatsapp: '67999000146' },
            
            // Ponta Por√£ - separado
            { codigo: 'Ponta Por√£-157', tipo: 'cargas', whatsapp: '67999000147' },
            { codigo: 'Ponta Por√£-158', tipo: 'cargas', whatsapp: '67999000148' },
            { codigo: 'Ponta Por√£-159', tipo: 'cargas', whatsapp: '67999000149' },
            
            // Presidente Prudente
            { codigo: 'Presidente Prudente-152', tipo: 'cargas', whatsapp: '67999000150' },
            
            // Ribas do Rio Pardo - separado
            { codigo: 'Ribas do Rio Pardo-169', tipo: 'cargas', whatsapp: '67999000151' },
            { codigo: 'Ribas do Rio Pardo-170', tipo: 'cargas', whatsapp: '67999000152' },
            
            // Rio Brilhante - separado
            { codigo: 'Rio Brilhante-160', tipo: 'cargas', whatsapp: '67999000153' },
            { codigo: 'Rio Brilhante-162', tipo: 'cargas', whatsapp: '67999000154' },
            
            // Rio Verde - separado
            { codigo: 'Rio Verde-172', tipo: 'cargas', whatsapp: '67999000155' },
            { codigo: 'Rio Verde-173', tipo: 'cargas', whatsapp: '67999000156' },
            
            // S√£o Gabriel do Oeste - separado
            { codigo: 'S√£o Gabriel do Oeste-178', tipo: 'cargas', whatsapp: '67999000157' },
            { codigo: 'S√£o Gabriel do Oeste-180', tipo: 'cargas', whatsapp: '67999000158' },
            
            // S√£o Paulo - separado
            { codigo: 'S√£o Paulo-187', tipo: 'cargas', whatsapp: '67999000159' },
            { codigo: 'S√£o Paulo-188', tipo: 'cargas', whatsapp: '67999000160' },
            { codigo: 'S√£o Paulo-189', tipo: 'cargas', whatsapp: '67999000161' },
            
            // Selv√≠ria - separado
            { codigo: 'Selv√≠ria-1', tipo: 'cargas', whatsapp: '67999000162' },
            { codigo: 'Selv√≠ria-2', tipo: 'cargas', whatsapp: '67999000163' },
            
            // Sonora - separado
            { codigo: 'Sonora-1', tipo: 'cargas', whatsapp: '67999000164' },
            { codigo: 'Sonora-2', tipo: 'cargas', whatsapp: '67999000165' },
            
            // Tacuru - separado
            { codigo: 'Tacuru-1', tipo: 'cargas', whatsapp: '67999000166' },
            { codigo: 'Tacuru-2', tipo: 'cargas', whatsapp: '67999000167' },
            
            // Terenos - separado
            { codigo: 'Terenos-315', tipo: 'cargas', whatsapp: '67999000168' },
            { codigo: 'Terenos-316', tipo: 'cargas', whatsapp: '67999000169' },
            
            // Tr√™s Lagoas - separado
            { codigo: 'Tr√™s Lagoas-194', tipo: 'cargas', whatsapp: '67999000170' },
            { codigo: 'Tr√™s Lagoas-195', tipo: 'cargas', whatsapp: '67999000171' }
        ];

        let floatingMenuVisible = false;
        let currentUser = null;
        let malotesEstoque = 0;
        let cadeadosEstoque = 0;

        // Fun√ß√£o para normalizar texto (remove acentos e converte para min√∫sculo)
        function normalizeText(text) {
            if (!text) return '';
            return text.toString()
                      .toLowerCase()
                      .normalize('NFD')
                      .replace(/[\u0300-\u036f]/g, '');
        }

        function getFilialByCode(codigo) {
            const codigoOriginal = codigo.toString().trim();
            const codigoNormalizado = normalizeText(codigoOriginal);
            
            console.log(`üîç Buscando c√≥digo: "${codigoOriginal}" (normalizado: "${codigoNormalizado}")`);
            
            // 1. Busca exata pelo c√≥digo completo
            let filial = filiais.find(f => {
                const codigoFilial = normalizeText(f.codigo);
                const match = codigoFilial === codigoNormalizado;
                if (match) console.log(`‚úÖ Match exato encontrado: ${f.codigo} (${f.tipo})`);
                return match;
            });
            
            if (filial) return filial;
            
            // 2. Busca apenas pelo n√∫mero (para c√≥digos como "87" que devem encontrar "Dourados-87")
            const numeroDigitado = codigoOriginal;
            filial = filiais.find(f => {
                const numeroFilial = f.codigo.split('-')[1];
                const match = numeroFilial === numeroDigitado;
                if (match) console.log(`‚úÖ Match por n√∫mero encontrado: ${f.codigo} (${f.tipo})`);
                return match;
            });
            
            if (filial) return filial;
            
            // 3. Busca por partes do c√≥digo (cidade + n√∫mero)
            const partes = codigoNormalizado.split(/[\s-]+/);
            if (partes.length >= 2) {
                const cidade = partes[0];
                const numero = partes[1];
                
                filial = filiais.find(f => {
                    const codigoFilial = normalizeText(f.codigo);
                    const partesFilial = codigoFilial.split('-');
                    const cidadeFilial = partesFilial[0];
                    const numeroFilial = partesFilial[1];
                    
                    const match = cidadeFilial.includes(cidade) && numeroFilial === numero;
                    if (match) console.log(`‚úÖ Match por partes encontrado: ${f.codigo} (${f.tipo})`);
                    return match;
                });
            }
            
            if (!filial) {
                console.log(`‚ùå Nenhum c√≥digo encontrado para: "${codigoOriginal}"`);
                console.log(`üìã C√≥digos dispon√≠veis (primeiros 10):`, filiais.slice(0, 10).map(f => f.codigo));
            }
            
            return filial;
        }

        // Fun√ß√µes de navega√ß√£o
        function showLogin() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('registerScreen').classList.add('hidden');
            document.getElementById('mainScreen').classList.add('hidden');
        }

        function showRegister() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('registerScreen').classList.remove('hidden');
            document.getElementById('mainScreen').classList.add('hidden');
        }

        function showMain() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('registerScreen').classList.add('hidden');
            document.getElementById('mainScreen').classList.remove('hidden');
            
            // Controla visibilidade do menu admin
            const adminMenu = document.getElementById('adminMenuSection');
            if (currentUser && normalizeText(currentUser.email) === normalizeText('R')) {
                adminMenu.classList.remove('hidden');
            } else {
                adminMenu.classList.add('hidden');
            }
            
            showSection('leituras');
            loadFilialOptions();
            loadExistingReadings();
        }

        function logout() {
            currentUser = null;
            showLogin();
            document.getElementById('loginForm').reset();
        }

        // Fun√ß√£o para gerar sauda√ß√£o personalizada
        function updateGreeting() {
            if (!currentUser) return;
            
            const now = new Date();
            const hour = now.getHours();
            let greeting = '';
            let icon = '';
            
            if (hour >= 5 && hour < 12) {
                greeting = 'Bom dia';
                icon = 'üåÖ';
            } else if (hour >= 12 && hour < 18) {
                greeting = 'Boa tarde';
                icon = '‚òÄÔ∏è';
            } else if (hour >= 18 && hour < 22) {
                greeting = 'Boa noite';
                icon = 'üåô';
            } else {
                greeting = 'Boa madrugada';
                icon = 'üåÉ';
            }
            
            // Pega o primeiro nome do usu√°rio
            const firstName = currentUser.name.split(' ')[0];
            
            const greetingElement = document.getElementById('greetingMessage');
            greetingElement.innerHTML = `
                <h3 class="text-lg font-semibold">${icon} ${greeting}, ${firstName}!</h3>
                <p class="text-sm opacity-90">Pronto para fazer as leituras de hoje?</p>
            `;
        }

        // Fun√ß√µes do menu flutuante
        function toggleFloatingMenu() {
            const menu = document.getElementById('floatingMenu');
            floatingMenuVisible = !floatingMenuVisible;
            
            if (floatingMenuVisible) {
                menu.classList.remove('hidden');
            } else {
                menu.classList.add('hidden');
            }
        }

        function showSection(section) {
            // Verifica se √© se√ß√£o admin e se usu√°rio tem permiss√£o
            if ((section === 'usuarios' || section === 'whatsapp-config') && 
                (!currentUser || normalizeText(currentUser.email) !== normalizeText('R'))) {
                alert('‚ùå Acesso negado! Apenas o administrador pode acessar esta se√ß√£o.');
                return;
            }
            
            const sections = ['malotes', 'leituras', 'cadeados', 'lavagem', 'troca', 'filiais', 'graficos', 'usuarios', 'whatsapp-config'];
            sections.forEach(s => {
                document.getElementById(s + 'Section').classList.add('hidden');
            });
            document.getElementById(section + 'Section').classList.remove('hidden');
            
            // Controla a visibilidade do bot√£o flutuante
            const reportButton = document.getElementById('reportButton');
            
            if (section === 'leituras' || section === 'lavagem' || section === 'troca') {
                reportButton.classList.remove('hidden');
                if (section === 'leituras') {
                    updateGreeting();
                    setTimeout(() => {
                        document.getElementById('barcodeInput').focus();
                    }, 100);
                }
            } else {
                reportButton.classList.add('hidden');
            }
            
            // Carrega dados espec√≠ficos da se√ß√£o
            if (section === 'malotes') {
                loadMalotesData();
            } else if (section === 'cadeados') {
                loadCadeadosData();
            } else if (section === 'troca') {
                loadTrocasData();
            } else if (section === 'lavagem') {
                loadLavagemData();
            } else if (section === 'filiais') {
                loadFiliaisData();
            } else if (section === 'usuarios') {
                loadUsuariosData();
            } else if (section === 'whatsapp-config') {
                loadWhatsAppConfigData();
            }
            
            if (floatingMenuVisible) {
                toggleFloatingMenu();
            }
        }

        // Fun√ß√µes de autentica√ß√£o
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            let email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            // Se digitou apenas "R" (mai√∫sculo ou min√∫sculo), aceita como login de administrador
            if (email.toUpperCase() === 'R' && password.toUpperCase() === 'R') {
                currentUser = { name: 'Administrador', email: 'R' };
                showMain();
                document.getElementById('loginMessage').classList.add('hidden');
                return;
            }
            
            try {
                const users = await window.firebaseDB.getUsers();
                const user = users.find(u => normalizeText(u.email) === normalizeText(email) && normalizeText(u.password) === normalizeText(password));
                
                if (user) {
                    currentUser = user;
                    showMain();
                    document.getElementById('loginMessage').classList.add('hidden');
                } else {
                    document.getElementById('loginMessage').textContent = 'Usu√°rio ou senha incorretos';
                    document.getElementById('loginMessage').classList.remove('hidden');
                }
            } catch (error) {
                document.getElementById('loginMessage').textContent = 'Erro ao fazer login. Tente novamente.';
                document.getElementById('loginMessage').classList.remove('hidden');
            }
        });

        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const messageDiv = document.getElementById('registerMessage');
            
            if (password !== confirmPassword) {
                messageDiv.textContent = 'As senhas n√£o coincidem';
                messageDiv.className = 'mt-4 text-center text-red-600';
                messageDiv.classList.remove('hidden');
                return;
            }
            
            try {
                const users = await window.firebaseDB.getUsers();
                if (users.find(u => normalizeText(u.email) === normalizeText(email))) {
                    messageDiv.textContent = 'Este email j√° est√° cadastrado';
                    messageDiv.className = 'mt-4 text-center text-red-600';
                    messageDiv.classList.remove('hidden');
                    return;
                }
                
                const success = await window.firebaseDB.addUser({ name, email, password });
                
                if (success) {
                    messageDiv.textContent = 'Usu√°rio cadastrado com sucesso!';
                    messageDiv.className = 'mt-4 text-center text-green-600';
                    messageDiv.classList.remove('hidden');
                    
                    setTimeout(() => {
                        showLogin();
                        document.getElementById('registerForm').reset();
                        messageDiv.classList.add('hidden');
                    }, 2000);
                } else {
                    messageDiv.textContent = 'Erro ao cadastrar usu√°rio. Tente novamente.';
                    messageDiv.className = 'mt-4 text-center text-red-600';
                    messageDiv.classList.remove('hidden');
                }
            } catch (error) {
                messageDiv.textContent = 'Erro ao cadastrar usu√°rio. Tente novamente.';
                messageDiv.className = 'mt-4 text-center text-red-600';
                messageDiv.classList.remove('hidden');
            }
        });

        // Fun√ß√£o de leitura de c√≥digo de barras - MANUAL E LEITOR
        document.getElementById('barcodeInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const codigo = this.value.trim();
                if (codigo) {
                    processBarcode(codigo);
                    this.value = '';
                }
            }
        });

        // Evento keydown para garantir compatibilidade total
        document.getElementById('barcodeInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const codigo = this.value.trim();
                if (codigo) {
                    processBarcode(codigo);
                    this.value = '';
                }
            }
        });

        // Auto-submit quando o leitor de c√≥digo de barras termina de ler
        let barcodeTimeout;
        let lastInputTime = 0;
        
        document.getElementById('barcodeInput').addEventListener('input', function(e) {
            const input = this;
            const currentTime = Date.now();
            
            clearTimeout(barcodeTimeout);
            
            // Se o tempo entre caracteres for muito r√°pido (leitor de c√≥digo) e tiver mais de 5 caracteres
            if (currentTime - lastInputTime < 50 && input.value.length > 5) {
                barcodeTimeout = setTimeout(() => {
                    const codigo = input.value.trim();
                    if (codigo) {
                        processBarcode(codigo);
                        input.value = '';
                    }
                }, 200);
            }
            
            lastInputTime = currentTime;
        });

        // Evento adicional para capturar QUALQUER forma de Enter
        document.getElementById('barcodeInput').addEventListener('keyup', function(e) {
            if (e.key === 'Enter' || e.keyCode === 13) {
                e.preventDefault();
                const codigo = this.value.trim();
                if (codigo) {
                    processBarcode(codigo);
                    this.value = '';
                }
            }
        });



        async function processBarcode(codigo) {
            const filial = getFilialByCode(codigo);
            const input = document.getElementById('barcodeInput');
            
            if (filial) {
                const now = new Date();
                const dataFormatada = now.toLocaleDateString('pt-BR') + ' √†s ' + now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                
                const leitura = {
                    filial: filial.codigo,
                    tipo: filial.tipo,
                    data: dataFormatada
                };
                
                const success = await window.firebaseDB.addLeitura(leitura);
                
                if (success) {
                    addRowToTable({...leitura, timestamp: now.getTime()});
                    document.getElementById('barcodeInput').focus();
                    
                    // Feedback visual de sucesso - VERDE
                    input.style.borderColor = '#10B981';
                    input.style.backgroundColor = '#ECFDF5';
                    input.style.color = '#065F46';
                    
                    // Mostra mensagem de sucesso
                    showFeedbackMessage(`‚úÖ ${filial.codigo} (${filial.tipo.toUpperCase()}) registrado com sucesso!`, 'success');
                    
                    setTimeout(() => {
                        input.style.borderColor = '';
                        input.style.backgroundColor = '';
                        input.style.color = '';
                    }, 2000);
                } else {
                    // Erro ao salvar no banco
                    input.style.borderColor = '#EF4444';
                    input.style.backgroundColor = '#FEF2F2';
                    input.style.color = '#991B1B';
                    showFeedbackMessage('‚ùå Erro ao salvar no banco de dados. Tente novamente.', 'error');
                    
                    setTimeout(() => {
                        input.style.borderColor = '';
                        input.style.backgroundColor = '';
                        input.style.color = '';
                    }, 3000);
                }
            } else {
                // C√≥digo n√£o encontrado no banco de dados - VERMELHO
                input.style.borderColor = '#EF4444';
                input.style.backgroundColor = '#FEF2F2';
                input.style.color = '#991B1B';
                
                showFeedbackMessage(`‚ùå C√≥digo "${codigo}" n√£o encontrado no banco de dados!`, 'error');
                document.getElementById('barcodeInput').focus();
                
                setTimeout(() => {
                    input.style.borderColor = '';
                    input.style.backgroundColor = '';
                    input.style.color = '';
                }, 3000);
            }
        }

        function showFeedbackMessage(message, type) {
            const feedbackDiv = document.getElementById('feedbackMessage');
            const feedbackText = document.getElementById('feedbackText');
            
            feedbackText.textContent = message;
            feedbackDiv.classList.remove('hidden');
            
            // Remove classes anteriores
            feedbackDiv.classList.remove('bg-green-100', 'text-green-800', 'border-green-300');
            feedbackDiv.classList.remove('bg-red-100', 'text-red-800', 'border-red-300');
            
            if (type === 'success') {
                feedbackDiv.classList.add('bg-green-100', 'text-green-800', 'border-green-300', 'border');
            } else if (type === 'error') {
                feedbackDiv.classList.add('bg-red-100', 'text-red-800', 'border-red-300', 'border');
            }
            
            // Auto-hide ap√≥s 4 segundos
            setTimeout(() => {
                feedbackDiv.classList.add('hidden');
            }, 4000);
        }

        function addRowToTable(leitura) {
            const table = document.getElementById('malotesTable');
            const row = table.insertRow(0);
            
            row.innerHTML = `
                <td class="border border-gray-300 px-4 py-3">${leitura.filial}</td>
                <td class="border border-gray-300 px-4 py-3 capitalize">${leitura.tipo}</td>
                <td class="border border-gray-300 px-4 py-3">${leitura.data}</td>
            `;
            
            row.style.backgroundColor = '#e6fffa';
            setTimeout(() => {
                row.style.backgroundColor = '';
            }, 2000);
        }

        // Fun√ß√µes do modal de relat√≥rios
        function showReportModal() {
            document.getElementById('reportModal').classList.remove('hidden');
            
            const today = new Date();
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            
            document.getElementById('startDate').value = startOfMonth.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
        }

        function closeReportModal() {
            document.getElementById('reportModal').classList.add('hidden');
            document.getElementById('reportResults').classList.add('hidden');
        }

        function loadFilialOptions() {
            const select = document.getElementById('filialFilter');
            
            select.innerHTML = '<option value="">Todas as filiais</option>';
            filiais.forEach(filial => {
                const option = document.createElement('option');
                option.value = filial.codigo;
                option.textContent = filial.codigo;
                select.appendChild(option);
            });
        }

        async function generateReport() {
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            const filialFilter = document.getElementById('filialFilter').value;
            
            // Configura hor√°rios para incluir o dia completo
            startDate.setHours(0, 0, 0, 0);
            endDate.setHours(23, 59, 59, 999);
            
            try {
                const leituras = await window.firebaseDB.getLeiturasFiltered(startDate, endDate, filialFilter);
                
                const reportTable = document.getElementById('reportTable');
                reportTable.innerHTML = '';
                
                if (leituras.length === 0) {
                    reportTable.innerHTML = '<tr><td colspan="3" class="border border-gray-300 px-3 py-2 text-center text-gray-500">Nenhum registro encontrado</td></tr>';
                } else {
                    leituras.forEach(leitura => {
                        const row = reportTable.insertRow();
                        row.innerHTML = `
                            <td class="border border-gray-300 px-3 py-2">${leitura.filial}</td>
                            <td class="border border-gray-300 px-3 py-2 capitalize">${leitura.tipo}</td>
                            <td class="border border-gray-300 px-3 py-2">${leitura.data}</td>
                        `;
                    });
                }
                
                document.getElementById('reportResults').classList.remove('hidden');
            } catch (error) {
                alert('Erro ao gerar relat√≥rio. Tente novamente.');
            }
        }

        async function loadExistingReadings() {
            try {
                const leituras = await window.firebaseDB.getLeituras();
                const table = document.getElementById('malotesTable');
                table.innerHTML = '';
                
                leituras.slice(0, 20).forEach(leitura => {
                    addRowToTable(leitura);
                });
            } catch (error) {
                console.error('Erro ao carregar leituras:', error);
            }
        }

        // Fun√ß√µes para Malotes
        async function adicionarMalotes() {
            const quantidade = parseInt(document.getElementById('malotesEntrada').value);
            if (!quantidade || quantidade <= 0) {
                alert('Por favor, insira uma quantidade v√°lida');
                return;
            }
            
            const now = new Date();
            const dataFormatada = now.toLocaleDateString('pt-BR') + ' √†s ' + now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            
            const movimento = {
                tipo: 'entrada',
                quantidade: quantidade,
                data: dataFormatada
            };
            
            const success = await window.firebaseDB.addMaloteMovimento(movimento);
            
            if (success) {
                malotesEstoque += quantidade;
                updateMalotesStock();
                addRowToMalotesTable(movimento);
                document.getElementById('malotesEntrada').value = '';
                alert(`${quantidade} malotes adicionados ao estoque!`);
            } else {
                alert('Erro ao adicionar malotes. Tente novamente.');
            }
        }

        async function trocarMalote() {
            const cidade = document.getElementById('maloteCidade').value.trim();
            const numero = document.getElementById('maloteNumero').value.trim();
            const motivo = document.getElementById('maloteMotivo').value.trim();
            
            if (!cidade || !numero || !motivo) {
                alert('Por favor, preencha todos os campos obrigat√≥rios (Cidade, N√∫mero e Motivo)');
                return;
            }
            
            if (malotesEstoque <= 0) {
                alert('N√£o h√° malotes em estoque para trocar!');
                return;
            }
            
            const now = new Date();
            const dataFormatada = now.toLocaleDateString('pt-BR') + ' √†s ' + now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            
            // Registra a troca na tabela de trocas
            const troca = {
                filial: `${cidade} - ${numero}`,
                troca: 'malote',
                motivo: motivo,
                data: dataFormatada
            };
            
            // Registra a sa√≠da no hist√≥rico de malotes
            const movimento = {
                tipo: 'troca',
                quantidade: -1,
                motivo: motivo,
                data: dataFormatada,
                observacao: `${cidade} - ${numero}`
            };
            
            const successTroca = await window.firebaseDB.addTroca(troca);
            const successMovimento = await window.firebaseDB.addMaloteMovimento(movimento);
            
            if (successTroca && successMovimento) {
                malotesEstoque -= 1;
                updateMalotesStock();
                addRowToMalotesTable(movimento);
                document.getElementById('maloteCidade').value = '';
                document.getElementById('maloteNumero').value = '';
                document.getElementById('maloteMotivo').value = '';
                alert('Troca de malote registrada com sucesso! Estoque reduzido em 1 unidade.');
            } else {
                alert('Erro ao registrar troca. Tente novamente.');
            }
        }

        // Fun√ß√µes para Cadeados
        async function adicionarCadeados() {
            const quantidade = parseInt(document.getElementById('cadeadosEntrada').value);
            if (!quantidade || quantidade <= 0) {
                alert('Por favor, insira uma quantidade v√°lida');
                return;
            }
            
            const now = new Date();
            const dataFormatada = now.toLocaleDateString('pt-BR') + ' √†s ' + now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            
            const movimento = {
                tipo: 'entrada',
                quantidade: quantidade,
                data: dataFormatada
            };
            
            const success = await window.firebaseDB.addCadeadoMovimento(movimento);
            
            if (success) {
                cadeadosEstoque += quantidade;
                updateCadeadosStock();
                addRowToCadeadosTable(movimento);
                document.getElementById('cadeadosEntrada').value = '';
                alert(`${quantidade} cadeados adicionados ao estoque!`);
            } else {
                alert('Erro ao adicionar cadeados. Tente novamente.');
            }
        }

        async function trocarCadeado() {
            const cidade = document.getElementById('cadeadoCidade').value.trim();
            const numero = document.getElementById('cadeadoNumero').value.trim();
            const motivo = document.getElementById('cadeadoMotivo').value.trim();
            
            if (!cidade || !numero || !motivo) {
                alert('Por favor, preencha todos os campos obrigat√≥rios (Cidade, N√∫mero e Motivo)');
                return;
            }
            
            if (cadeadosEstoque <= 0) {
                alert('N√£o h√° cadeados em estoque para trocar!');
                return;
            }
            
            const now = new Date();
            const dataFormatada = now.toLocaleDateString('pt-BR') + ' √†s ' + now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            
            // Registra a troca na tabela de trocas
            const troca = {
                filial: `${cidade} - ${numero}`,
                troca: 'cadeado',
                motivo: motivo,
                data: dataFormatada
            };
            
            // Registra a sa√≠da no hist√≥rico de cadeados
            const movimento = {
                tipo: 'troca',
                quantidade: -1,
                motivo: motivo,
                data: dataFormatada,
                observacao: `${cidade} - ${numero}`
            };
            
            const successTroca = await window.firebaseDB.addTroca(troca);
            const successMovimento = await window.firebaseDB.addCadeadoMovimento(movimento);
            
            if (successTroca && successMovimento) {
                cadeadosEstoque -= 1;
                updateCadeadosStock();
                addRowToCadeadosTable(movimento);
                document.getElementById('cadeadoCidade').value = '';
                document.getElementById('cadeadoNumero').value = '';
                document.getElementById('cadeadoMotivo').value = '';
                alert('Troca de cadeado registrada com sucesso! Estoque reduzido em 1 unidade.');
            } else {
                alert('Erro ao registrar troca. Tente novamente.');
            }
        }

        // Fun√ß√µes de atualiza√ß√£o de estoque
        function updateMalotesStock() {
            document.getElementById('malotesStock').textContent = `${malotesEstoque} malotes`;
        }

        function updateCadeadosStock() {
            document.getElementById('cadeadosStock').textContent = `${cadeadosEstoque} cadeados`;
        }

        // Fun√ß√µes para adicionar linhas nas tabelas
        function addRowToMalotesTable(movimento) {
            const table = document.getElementById('malotesHistorico');
            const row = table.insertRow(0);
            
            row.innerHTML = `
                <td class="border border-gray-300 px-4 py-3 capitalize">${movimento.tipo}</td>
                <td class="border border-gray-300 px-4 py-3">${movimento.quantidade}</td>
                <td class="border border-gray-300 px-4 py-3">${movimento.motivo || '-'}</td>
                <td class="border border-gray-300 px-4 py-3">${movimento.data}</td>
            `;
            
            row.style.backgroundColor = '#e6fffa';
            setTimeout(() => {
                row.style.backgroundColor = '';
            }, 2000);
        }

        function addRowToCadeadosTable(movimento) {
            const table = document.getElementById('cadeadosHistorico');
            const row = table.insertRow(0);
            
            row.innerHTML = `
                <td class="border border-gray-300 px-4 py-3 capitalize">${movimento.tipo}</td>
                <td class="border border-gray-300 px-4 py-3">${movimento.quantidade}</td>
                <td class="border border-gray-300 px-4 py-3">${movimento.motivo || '-'}</td>
                <td class="border border-gray-300 px-4 py-3">${movimento.data}</td>
            `;
            
            row.style.backgroundColor = '#e6fffa';
            setTimeout(() => {
                row.style.backgroundColor = '';
            }, 2000);
        }

        function addRowToTrocasTable(troca) {
            // Adiciona √† lista global
            allTrocas.unshift(troca);
            
            const table = document.getElementById('trocasTable');
            const row = table.insertRow(0);
            
            row.innerHTML = `
                <td class="border border-gray-300 px-4 py-3">${troca.filial}</td>
                <td class="border border-gray-300 px-4 py-3"></td>
                <td class="border border-gray-300 px-4 py-3 capitalize">${troca.troca}</td>
                <td class="border border-gray-300 px-4 py-3">${troca.motivo || '-'}</td>
                <td class="border border-gray-300 px-4 py-3">${troca.data}</td>
            `;
            
            row.style.backgroundColor = '#e6fffa';
            setTimeout(() => {
                row.style.backgroundColor = '';
            }, 2000);
        }

        // Fun√ß√£o para registrar lavagem
        async function registrarLavagem() {
            const cidade = document.getElementById('lavagemCidade').value.trim();
            const numero = document.getElementById('lavagemNumero').value.trim();
            
            if (!cidade || !numero) {
                alert('Por favor, preencha todos os campos obrigat√≥rios (Cidade e N√∫mero)');
                return;
            }
            
            const now = new Date();
            const dataFormatada = now.toLocaleDateString('pt-BR') + ' √†s ' + now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            
            const lavagem = {
                cidade: cidade,
                numero: numero,
                data: dataFormatada
            };
            
            const success = await window.firebaseDB.addLavagem(lavagem);
            
            if (success) {
                addRowToLavagemTable(lavagem);
                document.getElementById('lavagemCidade').value = '';
                document.getElementById('lavagemNumero').value = '';
                alert('Lavagem registrada com sucesso!');
            } else {
                alert('Erro ao registrar lavagem. Tente novamente.');
            }
        }

        function addRowToLavagemTable(lavagem) {
            // Adiciona √† lista global
            allLavagens.unshift(lavagem);
            
            const table = document.getElementById('lavagemHistorico');
            const row = table.insertRow(0);
            
            row.innerHTML = `
                <td class="border border-gray-300 px-4 py-3">${lavagem.cidade}</td>
                <td class="border border-gray-300 px-4 py-3">${lavagem.numero}</td>
                <td class="border border-gray-300 px-4 py-3">${lavagem.data}</td>
            `;
            
            row.style.backgroundColor = '#e6fffa';
            setTimeout(() => {
                row.style.backgroundColor = '';
            }, 2000);
        }

        async function loadLavagemData() {
            try {
                const lavagens = await window.firebaseDB.getLavagens();
                allLavagens = lavagens; // Armazena todos os dados para filtros
                displayLavagens(lavagens);
            } catch (error) {
                console.error('Erro ao carregar dados de lavagem:', error);
            }
        }

        // Fun√ß√µes para carregar dados
        async function loadMalotesData() {
            try {
                const movimentos = await window.firebaseDB.getMaloteMovimentos();
                const table = document.getElementById('malotesHistorico');
                table.innerHTML = '';
                
                // Calcula estoque atual
                malotesEstoque = 0;
                movimentos.forEach(movimento => {
                    if (movimento.tipo === 'entrada') {
                        malotesEstoque += movimento.quantidade;
                    } else if (movimento.tipo === 'troca') {
                        malotesEstoque += movimento.quantidade; // quantidade j√° √© negativa (-1)
                    }
                    addRowToMalotesTable(movimento);
                });
                
                updateMalotesStock();
            } catch (error) {
                console.error('Erro ao carregar dados de malotes:', error);
            }
        }

        async function loadCadeadosData() {
            try {
                const movimentos = await window.firebaseDB.getCadeadoMovimentos();
                const table = document.getElementById('cadeadosHistorico');
                table.innerHTML = '';
                
                // Calcula estoque atual
                cadeadosEstoque = 0;
                movimentos.forEach(movimento => {
                    if (movimento.tipo === 'entrada') {
                        cadeadosEstoque += movimento.quantidade;
                    } else if (movimento.tipo === 'troca') {
                        cadeadosEstoque += movimento.quantidade; // quantidade j√° √© negativa (-1)
                    }
                    addRowToCadeadosTable(movimento);
                });
                
                updateCadeadosStock();
            } catch (error) {
                console.error('Erro ao carregar dados de cadeados:', error);
            }
        }

        async function loadTrocasData() {
            try {
                const trocas = await window.firebaseDB.getTrocas();
                allTrocas = trocas; // Armazena todos os dados para filtros
                displayTrocas(trocas);
            } catch (error) {
                console.error('Erro ao carregar dados de trocas:', error);
            }
        }

        // Vari√°veis globais para filtros
        let allLavagens = [];
        let allTrocas = [];

        function displayLavagens(lavagens) {
            const table = document.getElementById('lavagemHistorico');
            table.innerHTML = '';
            
            if (lavagens.length === 0) {
                table.innerHTML = '<tr><td colspan="3" class="border border-gray-300 px-4 py-3 text-center text-gray-500">Nenhum registro encontrado</td></tr>';
                return;
            }
            
            lavagens.forEach(lavagem => {
                const row = table.insertRow();
                row.innerHTML = `
                    <td class="border border-gray-300 px-4 py-3">${lavagem.cidade}</td>
                    <td class="border border-gray-300 px-4 py-3">${lavagem.numero}</td>
                    <td class="border border-gray-300 px-4 py-3">${lavagem.data}</td>
                `;
            });
        }

        function displayTrocas(trocas) {
            const table = document.getElementById('trocasTable');
            table.innerHTML = '';
            
            if (trocas.length === 0) {
                table.innerHTML = '<tr><td colspan="5" class="border border-gray-300 px-4 py-3 text-center text-gray-500">Nenhum registro encontrado</td></tr>';
                return;
            }
            
            trocas.forEach(troca => {
                const row = table.insertRow();
                row.innerHTML = `
                    <td class="border border-gray-300 px-4 py-3">${troca.filial || '-'}</td>
                    <td class="border border-gray-300 px-4 py-3"></td>
                    <td class="border border-gray-300 px-4 py-3 capitalize">${troca.troca || '-'}</td>
                    <td class="border border-gray-300 px-4 py-3">${troca.motivo || '-'}</td>
                    <td class="border border-gray-300 px-4 py-3">${troca.data || '-'}</td>
                `;
            });
        }

        // Fun√ß√µes para Relat√≥rios Gr√°ficos
        function updateReportFilters() {
            const reportType = document.getElementById('reportType').value;
            const subTypeDiv = document.getElementById('subTypeDiv');
            
            if (reportType === 'troca') {
                subTypeDiv.classList.remove('hidden');
            } else {
                subTypeDiv.classList.add('hidden');
            }
        }

        async function generateGraphicReport() {
            const reportType = document.getElementById('reportType').value;
            const subType = document.getElementById('subType').value;
            const operationType = document.getElementById('operationType').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const filialFilter = document.getElementById('reportFilialFilter').value;
            
            if (!reportType || !startDate || !endDate) {
                alert('Por favor, preencha todos os campos obrigat√≥rios (Tipo de Relat√≥rio, Data Inicial e Data Final)');
                return;
            }
            
            try {
                let data = [];
                
                // Busca dados baseado no tipo de relat√≥rio
                if (reportType === 'malotes') {
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    // Configura hor√°rios para incluir o dia completo
                    start.setHours(0, 0, 0, 0);
                    end.setHours(23, 59, 59, 999);
                    
                    data = await window.firebaseDB.getLeiturasFiltered(start, end, filialFilter);
                    
                    // Adiciona informa√ß√£o de tipo baseado na filial
                    data = data.map(item => {
                        const filial = getFilialByCode(item.filial);
                        return {
                            ...item,
                            operationType: filial ? filial.tipo : 'desconhecido'
                        };
                    });
                    
                } else if (reportType === 'lavagem') {
                    const lavagens = await window.firebaseDB.getLavagens();
                    data = filterDataByDate(lavagens, startDate, endDate);
                    
                    // Para lavagem, n√£o temos tipo de opera√ß√£o espec√≠fico
                    data = data.map(item => ({
                        ...item,
                        filial: `${item.cidade} - ${item.numero}`,
                        operationType: 'lavagem'
                    }));
                    
                } else if (reportType === 'troca') {
                    const trocas = await window.firebaseDB.getTrocas();
                    data = filterDataByDate(trocas, startDate, endDate);
                    
                    // Filtra por subtipo se especificado
                    if (subType) {
                        data = data.filter(item => item.troca === subType);
                    }
                    
                    // Para trocas, o tipo de opera√ß√£o √© baseado na filial se dispon√≠vel
                    data = data.map(item => {
                        const filial = getFilialByCode(item.filial);
                        return {
                            ...item,
                            operationType: filial ? filial.tipo : 'troca'
                        };
                    });
                }
                
                // Filtra por tipo de opera√ß√£o se especificado
                if (operationType) {
                    data = data.filter(item => item.operationType === operationType);
                }
                
                // Filtra por filial se especificado (para relat√≥rios que n√£o s√£o de malotes)
                if (filialFilter && reportType !== 'malotes') {
                    data = data.filter(item => normalizeText(item.filial).includes(normalizeText(filialFilter)));
                }
                
                displayGraphicReport(data, reportType);
                
            } catch (error) {
                console.error('Erro ao gerar relat√≥rio:', error);
                alert('Erro ao gerar relat√≥rio. Tente novamente.');
            }
        }

        function filterDataByDate(data, startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            // Configura hor√°rios para incluir o dia completo
            start.setHours(0, 0, 0, 0);
            end.setHours(23, 59, 59, 999);
            
            return data.filter(item => {
                // Cria data do item considerando diferentes formatos
                let itemDate;
                if (item.timestamp) {
                    itemDate = new Date(item.timestamp);
                } else if (item.data) {
                    // Tenta extrair data do formato "DD/MM/AAAA √†s HH:MM"
                    const dateMatch = item.data.match(/(\d{2})\/(\d{2})\/(\d{4})/);
                    if (dateMatch) {
                        const [, day, month, year] = dateMatch;
                        itemDate = new Date(year, month - 1, day);
                    } else {
                        itemDate = new Date(item.data);
                    }
                } else {
                    return false;
                }
                
                // Verifica se a data √© v√°lida
                if (isNaN(itemDate.getTime())) {
                    return false;
                }
                
                // Compara apenas as datas (sem hor√°rio)
                const itemDateOnly = new Date(itemDate.getFullYear(), itemDate.getMonth(), itemDate.getDate());
                const startDateOnly = new Date(start.getFullYear(), start.getMonth(), start.getDate());
                const endDateOnly = new Date(end.getFullYear(), end.getMonth(), end.getDate());
                
                return itemDateOnly >= startDateOnly && itemDateOnly <= endDateOnly;
            });
        }

        function displayGraphicReport(data, reportType) {
            // Mostra a se√ß√£o de resultados
            document.getElementById('reportGraphicResults').classList.remove('hidden');
            
            // Calcula estat√≠sticas
            const totalRecords = data.length;
            const totalCargas = data.filter(item => item.operationType === 'cargas').length;
            const totalPassagens = data.filter(item => item.operationType === 'passagens').length;
            
            // Atualiza resumo
            document.getElementById('totalRecords').textContent = totalRecords;
            document.getElementById('totalCargas').textContent = totalCargas;
            document.getElementById('totalPassagens').textContent = totalPassagens;
            
            // Gera gr√°fico por filial
            generateFilialChart(data);
            
            // Gera gr√°fico por tipo
            generateTypeChart(data);
            
            // Atualiza tabela detalhada
            updateDetailTable(data, reportType);
            
            // Armazena dados para exporta√ß√£o
            window.currentReportData = data;
            window.currentReportType = reportType;
        }

        function generateFilialChart(data) {
            const filialChart = document.getElementById('filialChart');
            
            // Conta registros por filial
            const filialCounts = {};
            data.forEach(item => {
                const filial = item.filial || 'N√£o especificado';
                filialCounts[filial] = (filialCounts[filial] || 0) + 1;
            });
            
            // Encontra o valor m√°ximo para escala
            const maxCount = Math.max(...Object.values(filialCounts), 1);
            
            // Gera barras do gr√°fico
            filialChart.innerHTML = '';
            
            if (Object.keys(filialCounts).length === 0) {
                filialChart.innerHTML = '<div class="text-gray-500 text-center w-full">Nenhum dado encontrado</div>';
                return;
            }
            
            Object.entries(filialCounts).forEach(([filial, count]) => {
                const percentage = (count / maxCount) * 100;
                const bar = document.createElement('div');
                bar.className = 'flex flex-col items-center';
                bar.innerHTML = `
                    <div class="bg-blue-500 rounded-t" style="height: ${Math.max(percentage, 5)}%; width: 40px; min-height: 20px;"></div>
                    <div class="text-xs mt-2 text-center font-medium">${count}</div>
                    <div class="text-xs text-gray-600 text-center max-w-20 break-words">${filial.split('-')[0] || filial}</div>
                `;
                filialChart.appendChild(bar);
            });
        }

        function generateTypeChart(data) {
            const typeChart = document.getElementById('typeChart');
            
            // Conta registros por tipo
            const typeCounts = {};
            data.forEach(item => {
                const type = item.operationType || 'N√£o especificado';
                typeCounts[type] = (typeCounts[type] || 0) + 1;
            });
            
            // Gera gr√°fico de pizza simples
            typeChart.innerHTML = '';
            
            if (Object.keys(typeCounts).length === 0) {
                typeChart.innerHTML = '<div class="text-gray-500">Nenhum dado encontrado</div>';
                return;
            }
            
            const total = Object.values(typeCounts).reduce((a, b) => a + b, 0);
            const colors = ['bg-green-500', 'bg-orange-500', 'bg-purple-500', 'bg-red-500'];
            
            Object.entries(typeCounts).forEach(([type, count], index) => {
                const percentage = ((count / total) * 100).toFixed(1);
                const item = document.createElement('div');
                item.className = 'flex flex-col items-center';
                item.innerHTML = `
                    <div class="w-16 h-16 ${colors[index % colors.length]} rounded-full flex items-center justify-center text-white font-bold text-lg">
                        ${count}
                    </div>
                    <div class="text-sm font-medium mt-2 capitalize">${type}</div>
                    <div class="text-xs text-gray-600">${percentage}%</div>
                `;
                typeChart.appendChild(item);
            });
        }

        function updateDetailTable(data, reportType) {
            const table = document.getElementById('reportDetailTable');
            const dynamicColumn = document.getElementById('dynamicColumn');
            
            // Atualiza cabe√ßalho da coluna din√¢mica
            if (reportType === 'malotes') {
                dynamicColumn.textContent = 'Opera√ß√£o';
            } else if (reportType === 'lavagem') {
                dynamicColumn.textContent = 'N√∫mero';
            } else if (reportType === 'troca') {
                dynamicColumn.textContent = 'Motivo';
            }
            
            // Limpa tabela
            table.innerHTML = '';
            
            if (data.length === 0) {
                table.innerHTML = '<tr><td colspan="4" class="border border-gray-300 px-3 py-2 text-center text-gray-500">Nenhum registro encontrado</td></tr>';
                return;
            }
            
            // Adiciona linhas
            data.forEach(item => {
                const row = table.insertRow();
                let dynamicValue = '';
                
                if (reportType === 'malotes') {
                    dynamicValue = item.operationType || '-';
                } else if (reportType === 'lavagem') {
                    dynamicValue = item.numero || '-';
                } else if (reportType === 'troca') {
                    dynamicValue = item.motivo || '-';
                }
                
                row.innerHTML = `
                    <td class="border border-gray-300 px-3 py-2">${item.filial || '-'}</td>
                    <td class="border border-gray-300 px-3 py-2 capitalize">${item.operationType || '-'}</td>
                    <td class="border border-gray-300 px-3 py-2">${dynamicValue}</td>
                    <td class="border border-gray-300 px-3 py-2">${item.data || '-'}</td>
                `;
            });
        }

        // Fun√ß√µes de exporta√ß√£o
        function exportToExcel() {
            if (!window.currentReportData || !window.currentReportType) {
                alert('Nenhum relat√≥rio gerado para exportar');
                return;
            }
            
            try {
                const data = window.currentReportData;
                const reportType = window.currentReportType;
                
                // Verifica se XLSX est√° dispon√≠vel
                if (typeof XLSX === 'undefined') {
                    // Fallback: cria CSV simples
                    exportToCSV(data, reportType);
                    return;
                }
                
                // Prepara dados para Excel
                const excelData = data.map(item => {
                    let row = {
                        'Filial': item.filial || '',
                        'Tipo': item.operationType || ''
                    };
                    
                    if (reportType === 'malotes') {
                        row['Opera√ß√£o'] = item.operationType || '';
                    } else if (reportType === 'lavagem') {
                        row['N√∫mero'] = item.numero || '';
                    } else if (reportType === 'troca') {
                        row['Motivo'] = item.motivo || '';
                    }
                    
                    row['Data'] = item.data || '';
                    return row;
                });
                
                // Cria workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(excelData);
                
                // Adiciona worksheet
                XLSX.utils.book_append_sheet(wb, ws, `Relat√≥rio ${reportType}`);
                
                // Salva arquivo
                const fileName = `relatorio_${reportType}_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                alert('Arquivo Excel exportado com sucesso!');
            } catch (error) {
                console.error('Erro ao exportar Excel:', error);
                // Fallback para CSV
                exportToCSV(window.currentReportData, window.currentReportType);
            }
        }
        
        function exportToCSV(data, reportType) {
            try {
                // Cabe√ßalhos
                let headers = ['Filial', 'Tipo'];
                if (reportType === 'malotes') {
                    headers.push('Opera√ß√£o');
                } else if (reportType === 'lavagem') {
                    headers.push('N√∫mero');
                } else if (reportType === 'troca') {
                    headers.push('Motivo');
                }
                headers.push('Data');
                
                // Dados
                const csvData = [headers];
                data.forEach(item => {
                    let row = [item.filial || '', item.operationType || ''];
                    
                    if (reportType === 'malotes') {
                        row.push(item.operationType || '');
                    } else if (reportType === 'lavagem') {
                        row.push(item.numero || '');
                    } else if (reportType === 'troca') {
                        row.push(item.motivo || '');
                    }
                    
                    row.push(item.data || '');
                    csvData.push(row);
                });
                
                // Converte para CSV
                const csvContent = csvData.map(row => row.join(',')).join('\n');
                
                // Cria e baixa arquivo
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `relatorio_${reportType}_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert('Arquivo CSV exportado com sucesso!');
            } catch (error) {
                console.error('Erro ao exportar CSV:', error);
                alert('Erro ao exportar dados. Tente novamente.');
            }
        }

        function exportToPDF() {
            if (!window.currentReportData || !window.currentReportType) {
                alert('Nenhum relat√≥rio gerado para exportar');
                return;
            }
            
            try {
                const data = window.currentReportData;
                const reportType = window.currentReportType;
                
                // Verifica se jsPDF est√° dispon√≠vel
                if (typeof window.jspdf === 'undefined' || !window.jspdf.jsPDF) {
                    // Fallback: usar impress√£o
                    alert('Biblioteca PDF n√£o dispon√≠vel. Usando impress√£o como alternativa.');
                    printReport();
                    return;
                }
                
                // Cria novo documento PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // T√≠tulo do relat√≥rio
                const reportTitle = `Relat√≥rio de ${reportType.charAt(0).toUpperCase() + reportType.slice(1)}`;
                doc.setFontSize(16);
                doc.text(reportTitle, 20, 20);
                
                // Data de gera√ß√£o
                doc.setFontSize(10);
                doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}`, 20, 30);
                
                // Resumo
                const totalRecords = data.length;
                const totalCargas = data.filter(item => item.operationType === 'cargas').length;
                const totalPassagens = data.filter(item => item.operationType === 'passagens').length;
                
                doc.text(`Total de Registros: ${totalRecords}`, 20, 45);
                doc.text(`Cargas: ${totalCargas}`, 20, 52);
                doc.text(`Passagens: ${totalPassagens}`, 20, 59);
                
                // Tabela simples (sem autoTable)
                let yPosition = 80;
                doc.setFontSize(8);
                
                // Cabe√ßalhos
                let headers = ['Filial', 'Tipo'];
                if (reportType === 'malotes') {
                    headers.push('Opera√ß√£o');
                } else if (reportType === 'lavagem') {
                    headers.push('N√∫mero');
                } else if (reportType === 'troca') {
                    headers.push('Motivo');
                }
                headers.push('Data');
                
                headers.forEach((header, index) => {
                    doc.text(header, 20 + (index * 40), yPosition);
                });
                yPosition += 10;
                
                // Dados
                data.slice(0, 30).forEach(item => { // Limita a 30 registros para evitar problemas
                    let row = [item.filial || '', item.operationType || ''];
                    
                    if (reportType === 'malotes') {
                        row.push(item.operationType || '');
                    } else if (reportType === 'lavagem') {
                        row.push(item.numero || '');
                    } else if (reportType === 'troca') {
                        row.push(item.motivo || '');
                    }
                    
                    row.push(item.data || '');
                    
                    row.forEach((cell, index) => {
                        const text = String(cell).substring(0, 15); // Limita tamanho do texto
                        doc.text(text, 20 + (index * 40), yPosition);
                    });
                    yPosition += 8;
                    
                    if (yPosition > 280) { // Nova p√°gina se necess√°rio
                        doc.addPage();
                        yPosition = 20;
                    }
                });
                
                // Salva PDF
                const fileName = `relatorio_${reportType}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                alert('Arquivo PDF exportado com sucesso!');
            } catch (error) {
                console.error('Erro ao exportar PDF:', error);
                // Fallback para impress√£o
                alert('Erro ao gerar PDF. Usando impress√£o como alternativa.');
                printReport();
            }
        }

        function printReport() {
            if (!window.currentReportData || !window.currentReportType) {
                alert('Nenhum relat√≥rio gerado para imprimir');
                return;
            }
            
            try {
                const data = window.currentReportData;
                const reportType = window.currentReportType;
                
                // Cria √°rea de impress√£o
                const printContent = document.createElement('div');
                printContent.className = 'print-area';
                printContent.id = 'printArea';
                
                // Cabe√ßalho
                const reportTitle = `Relat√≥rio de ${reportType.charAt(0).toUpperCase() + reportType.slice(1)}`;
                const totalRecords = data.length;
                const totalCargas = data.filter(item => item.operationType === 'cargas').length;
                const totalPassagens = data.filter(item => item.operationType === 'passagens').length;
                
                printContent.innerHTML = `
                    <div class="print-header">
                        <h1 style="margin: 0; font-size: 24px; font-weight: bold; color: #333;">Controle de Malotes</h1>
                        <h2 style="margin: 10px 0; font-size: 18px; color: #666;">${reportTitle}</h2>
                        <p style="margin: 5px 0; color: #666;">Gerado em: ${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}</p>
                    </div>
                    
                    <div style="margin-bottom: 20px; padding: 15px; border: 2px solid #333; background-color: #f9f9f9;">
                        <h3 style="margin: 0 0 10px 0; color: #333;">üìä Resumo do Relat√≥rio</h3>
                        <p style="margin: 5px 0; color: #333;"><strong>Total de Registros:</strong> ${totalRecords}</p>
                        <p style="margin: 5px 0; color: #333;"><strong>Cargas:</strong> ${totalCargas}</p>
                        <p style="margin: 5px 0; color: #333;"><strong>Passagens:</strong> ${totalPassagens}</p>
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-top: 20px; border: 2px solid #333;">
                        <thead>
                            <tr style="background-color: #f0f0f0;">
                                <th style="border: 1px solid #333; padding: 12px; text-align: left; font-weight: bold;">Filial</th>
                                <th style="border: 1px solid #333; padding: 12px; text-align: left; font-weight: bold;">Tipo</th>
                                <th style="border: 1px solid #333; padding: 12px; text-align: left; font-weight: bold;">${reportType === 'malotes' ? 'Opera√ß√£o' : reportType === 'lavagem' ? 'N√∫mero' : 'Motivo'}</th>
                                <th style="border: 1px solid #333; padding: 12px; text-align: left; font-weight: bold;">Data</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(item => {
                                let dynamicValue = '';
                                if (reportType === 'malotes') {
                                    dynamicValue = item.operationType || '-';
                                } else if (reportType === 'lavagem') {
                                    dynamicValue = item.numero || '-';
                                } else if (reportType === 'troca') {
                                    dynamicValue = item.motivo || '-';
                                }
                                
                                return `
                                    <tr>
                                        <td style="border: 1px solid #333; padding: 8px;">${item.filial || '-'}</td>
                                        <td style="border: 1px solid #333; padding: 8px;">${item.operationType || '-'}</td>
                                        <td style="border: 1px solid #333; padding: 8px;">${dynamicValue}</td>
                                        <td style="border: 1px solid #333; padding: 8px;">${item.data || '-'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
                
                // Remove √°rea de impress√£o anterior se existir
                const existingPrintArea = document.getElementById('printArea');
                if (existingPrintArea) {
                    document.body.removeChild(existingPrintArea);
                }
                
                // Adiciona ao body
                document.body.appendChild(printContent);
                
                // Aguarda um momento para garantir que o conte√∫do foi renderizado
                setTimeout(() => {
                    // Imprime
                    window.print();
                    
                    // Remove ap√≥s impress√£o
                    setTimeout(() => {
                        const printArea = document.getElementById('printArea');
                        if (printArea) {
                            document.body.removeChild(printArea);
                        }
                    }, 1000);
                }, 100);
                
            } catch (error) {
                console.error('Erro ao imprimir:', error);
                alert('Erro ao preparar impress√£o. Tente novamente.');
            }
        }

        // Vari√°veis globais para filiais
        let allFiliaisData = [];
        let filteredFiliaisData = [];

        // Fun√ß√µes para Filiais
        async function loadFiliaisData() {
            try {
                // Carrega todas as leituras do banco
                const leituras = await window.firebaseDB.getLeituras();
                
                // Processa dados das filiais
                const filiaisMap = new Map();
                
                // Inicializa todas as filiais do banco de dados local
                filiais.forEach(filial => {
                    filiaisMap.set(filial.codigo, {
                        codigo: filial.codigo,
                        tipo: filial.tipo,
                        whatsapp: filial.whatsapp,
                        leituras: [],
                        totalLeituras: 0,
                        ultimaLeitura: null,
                        status: 'sem-leitura'
                    });
                });
                
                // Adiciona dados das leituras
                leituras.forEach(leitura => {
                    if (filiaisMap.has(leitura.filial)) {
                        const filialData = filiaisMap.get(leitura.filial);
                        filialData.leituras.push(leitura);
                        filialData.totalLeituras++;
                        
                        // Atualiza √∫ltima leitura (considera timestamp se dispon√≠vel)
                        const leituraDate = leitura.timestamp ? new Date(leitura.timestamp) : new Date(leitura.data);
                        if (!filialData.ultimaLeitura || leituraDate > new Date(filialData.ultimaLeitura)) {
                            filialData.ultimaLeitura = leitura.data;
                        }
                        
                        filialData.status = 'com-leitura';
                    }
                });
                
                // Converte Map para Array
                allFiliaisData = Array.from(filiaisMap.values());
                filteredFiliaisData = [...allFiliaisData];
                
                // Atualiza interface
                updateFiliaisDisplay();
                updateFiliaisStats();
                
            } catch (error) {
                console.error('Erro ao carregar dados das filiais:', error);
                alert('Erro ao carregar dados das filiais. Tente novamente.');
            }
        }

        function filterFiliais() {
            const statusFilter = document.getElementById('statusFilter').value;
            const tipoFilter = document.getElementById('tipoFilter').value;
            const periodoFilter = document.getElementById('periodoFilter').value;
            const searchText = normalizeText(document.getElementById('searchFilial').value);
            
            filteredFiliaisData = allFiliaisData.filter(filial => {
                // Filtro por status
                if (statusFilter === 'lidas' && filial.status === 'sem-leitura') return false;
                if (statusFilter === 'nao-lidas' && filial.status === 'com-leitura') return false;
                
                // Filtro por tipo
                if (tipoFilter && filial.tipo !== tipoFilter) return false;
                
                // Filtro por busca de texto
                if (searchText && !normalizeText(filial.codigo).includes(searchText)) return false;
                
                // Filtro por per√≠odo
                if (periodoFilter !== 'todos' && filial.status === 'com-leitura') {
                    const now = new Date();
                    const ultimaLeitura = new Date(filial.ultimaLeitura);
                    
                    if (periodoFilter === 'hoje') {
                        const hoje = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        const leituraDate = new Date(ultimaLeitura.getFullYear(), ultimaLeitura.getMonth(), ultimaLeitura.getDate());
                        if (leituraDate.getTime() !== hoje.getTime()) return false;
                    } else if (periodoFilter === 'semana') {
                        const semanaAtras = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        if (ultimaLeitura < semanaAtras) return false;
                    } else if (periodoFilter === 'mes') {
                        const mesAtras = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                        if (ultimaLeitura < mesAtras) return false;
                    }
                }
                
                return true;
            });
            
            updateFiliaisDisplay();
            updateFiliaisStats();
        }

        function clearFilters() {
            document.getElementById('statusFilter').value = '';
            document.getElementById('tipoFilter').value = '';
            document.getElementById('periodoFilter').value = 'mes';
            document.getElementById('searchFilial').value = '';
            
            filteredFiliaisData = [...allFiliaisData];
            updateFiliaisDisplay();
            updateFiliaisStats();
        }

        function updateFiliaisDisplay() {
            const table = document.getElementById('filiaisTable');
            table.innerHTML = '';
            
            if (filteredFiliaisData.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="6" class="border border-gray-300 px-4 py-8 text-center text-gray-500">
                            <i class="fas fa-search text-4xl mb-4 block"></i>
                            <p class="text-lg font-medium">Nenhuma filial encontrada</p>
                            <p class="text-sm">Tente ajustar os filtros para ver mais resultados</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Ordena por status (sem leitura primeiro) e depois por nome
            const sortedFiliais = [...filteredFiliaisData].sort((a, b) => {
                if (a.status !== b.status) {
                    return a.status === 'sem-leitura' ? -1 : 1;
                }
                return a.codigo.localeCompare(b.codigo);
            });
            
            sortedFiliais.forEach(filial => {
                const row = table.insertRow();
                
                // Status visual
                const statusIcon = filial.status === 'com-leitura' 
                    ? '<i class="fas fa-check-circle text-green-500 mr-2"></i>' 
                    : '<i class="fas fa-times-circle text-red-500 mr-2"></i>';
                
                const statusText = filial.status === 'com-leitura' ? 'Com leituras' : 'Sem leituras';
                const statusClass = filial.status === 'com-leitura' ? 'text-green-700 bg-green-50' : 'text-red-700 bg-red-50';
                
                // Tipo com cor
                const tipoClass = filial.tipo === 'cargas' ? 'text-blue-700 bg-blue-50' : 'text-orange-700 bg-orange-50';
                const tipoIcon = filial.tipo === 'cargas' ? '<i class="fas fa-truck mr-1"></i>' : '<i class="fas fa-users mr-1"></i>';
                
                row.innerHTML = `
                    <td class="border border-gray-300 px-4 py-3">
                        <div class="font-medium text-gray-900">${filial.codigo}</div>
                    </td>
                    <td class="border border-gray-300 px-4 py-3">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${tipoClass}">
                            ${tipoIcon}${filial.tipo.charAt(0).toUpperCase() + filial.tipo.slice(1)}
                        </span>
                    </td>
                    <td class="border border-gray-300 px-4 py-3">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
                            ${statusIcon}${statusText}
                        </span>
                    </td>
                    <td class="border border-gray-300 px-4 py-3 text-sm text-gray-600">
                        ${filial.ultimaLeitura || '-'}
                    </td>
                    <td class="border border-gray-300 px-4 py-3 text-center">
                        <span class="inline-flex items-center justify-center w-8 h-8 rounded-full ${filial.totalLeituras > 0 ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-600'} text-sm font-bold">
                            ${filial.totalLeituras}
                        </span>
                    </td>
                    <td class="border border-gray-300 px-4 py-3 text-center">
                        <div class="flex items-center justify-center space-x-2">
                            <span class="text-sm text-gray-600">${filial.whatsapp || '-'}</span>
                            ${filial.whatsapp ? `
                                <button onclick="sendWhatsAppToFilial('${filial.codigo}', '${filial.whatsapp}')" 
                                        class="bg-green-500 text-white p-1 rounded-full hover:bg-green-600 transition text-xs">
                                    <i class="fab fa-whatsapp"></i>
                                </button>
                            ` : ''}
                        </div>
                    </td>
                `;
                
                // Destaca filiais sem leitura
                if (filial.status === 'sem-leitura') {
                    row.classList.add('bg-red-50');
                }
            });
        }

        function updateFiliaisStats() {
            const total = filteredFiliaisData.length;
            const comLeituras = filteredFiliaisData.filter(f => f.status === 'com-leitura').length;
            const semLeituras = total - comLeituras;
            const percentual = total > 0 ? Math.round((comLeituras / total) * 100) : 0;
            
            document.getElementById('totalFiliais').textContent = total;
            document.getElementById('filiaisLidas').textContent = comLeituras;
            document.getElementById('filiaisNaoLidas').textContent = semLeituras;
            document.getElementById('percentualLeituras').textContent = `${percentual}%`;
        }

        // Fun√ß√µes de WhatsApp
        function sendWhatsAppToFilial(filialCodigo, whatsapp) {
            const message = `üö® *ALERTA - CONTROLE DE MALOTES* üö®

Ol√°! Notamos que a filial *${filialCodigo}* ainda n√£o teve o malote lido hoje.

üìÖ Data: ${new Date().toLocaleDateString('pt-BR')}
‚è∞ Hor√°rio: ${new Date().toLocaleTimeString('pt-BR')}

Por favor, verifique se:
‚úÖ O malote foi entregue
‚úÖ O c√≥digo foi lido corretamente
‚úÖ N√£o h√° problemas no sistema

Entre em contato conosco se precisar de ajuda!

*Controle de Malotes - Sistema Automatizado*`;

            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/55${whatsapp}?text=${encodedMessage}`;
            
            // Abre o WhatsApp Web/App
            window.open(whatsappUrl, '_blank');
        }

        async function sendWhatsAppToUnread() {
            try {
                // Busca leituras de hoje
                const hoje = new Date();
                const inicioHoje = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
                const fimHoje = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate(), 23, 59, 59);
                
                const leiturasHoje = await window.firebaseDB.getLeiturasFiltered(inicioHoje, fimHoje, '');
                
                // Cria set com filiais que j√° foram lidas hoje
                const filiaisLidasHoje = new Set();
                leiturasHoje.forEach(leitura => {
                    filiaisLidasHoje.add(leitura.filial);
                });
                
                // Encontra filiais sem leitura hoje
                const filiaisSemLeitura = filiais.filter(filial => 
                    !filiaisLidasHoje.has(filial.codigo) && filial.whatsapp
                );
                
                if (filiaisSemLeitura.length === 0) {
                    alert('üéâ Todas as filiais j√° foram lidas hoje! Parab√©ns!');
                    return;
                }
                
                const confirmacao = confirm(`üì± Deseja enviar WhatsApp para ${filiaisSemLeitura.length} filiais que n√£o tiveram leitura hoje?\n\nFiliais: ${filiaisSemLeitura.map(f => f.codigo).join(', ')}`);
                
                if (!confirmacao) return;
                
                // Envia mensagem para cada filial
                let contador = 0;
                const intervalo = 2000; // 2 segundos entre cada envio
                
                const enviarProxima = () => {
                    if (contador >= filiaisSemLeitura.length) {
                        alert(`‚úÖ Processo conclu√≠do! ${contador} mensagens foram enviadas.`);
                        return;
                    }
                    
                    const filial = filiaisSemLeitura[contador];
                    sendWhatsAppToFilial(filial.codigo, filial.whatsapp);
                    contador++;
                    
                    // Agenda pr√≥ximo envio
                    setTimeout(enviarProxima, intervalo);
                };
                
                // Inicia o processo
                enviarProxima();
                
            } catch (error) {
                console.error('Erro ao enviar WhatsApp:', error);
                alert('‚ùå Erro ao processar envio de WhatsApp. Tente novamente.');
            }
        }

        // Sistema de Agendamento de WhatsApp
        function scheduleWhatsAppMessages() {
            const now = new Date();
            const targetTime = new Date();
            
            // Define hor√°rio para 04:08 de hoje
            targetTime.setHours(4, 8, 0, 0);
            
            // Se j√° passou das 04:08 hoje, agenda para amanh√£
            if (now > targetTime) {
                targetTime.setDate(targetTime.getDate() + 1);
            }
            
            const timeUntilTarget = targetTime.getTime() - now.getTime();
            
            console.log(`‚è∞ Agendamento configurado para: ${targetTime.toLocaleString('pt-BR')}`);
            console.log(`‚è±Ô∏è Tempo restante: ${Math.round(timeUntilTarget / 1000 / 60)} minutos`);
            
            setTimeout(async () => {
                await checkAndSendScheduledMessages();
                // Reagenda para o pr√≥ximo dia
                setTimeout(scheduleWhatsAppMessages, 24 * 60 * 60 * 1000);
            }, timeUntilTarget);
        }
        
        async function checkAndSendScheduledMessages() {
            try {
                console.log('üîç Verificando filiais sem leitura para envio autom√°tico...');
                
                // Busca leituras de hoje
                const hoje = new Date();
                const inicioHoje = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
                const fimHoje = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate(), 23, 59, 59);
                
                const leiturasHoje = await window.firebaseDB.getLeiturasFiltered(inicioHoje, fimHoje, '');
                
                // Cria set com filiais que j√° foram lidas hoje
                const filiaisLidasHoje = new Set();
                leiturasHoje.forEach(leitura => {
                    filiaisLidasHoje.add(leitura.filial);
                });
                
                // Verifica especificamente a filial √Ågua Clara-02
                const aguaClaraFilial = filiais.find(f => f.codigo === '√Ågua Clara-02');
                
                if (aguaClaraFilial && !filiaisLidasHoje.has('√Ågua Clara-02')) {
                    console.log('üì± Enviando WhatsApp autom√°tico para √Ågua Clara-02...');
                    sendScheduledWhatsApp(aguaClaraFilial.codigo, aguaClaraFilial.whatsapp);
                } else if (filiaisLidasHoje.has('√Ågua Clara-02')) {
                    console.log('‚úÖ √Ågua Clara-02 j√° foi lida hoje. N√£o enviando mensagem.');
                } else {
                    console.log('‚ùå Filial √Ågua Clara-02 n√£o encontrada.');
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao verificar filiais para envio autom√°tico:', error);
            }
        }
        
        function sendScheduledWhatsApp(filialCodigo, whatsapp) {
            const message = `Bom dia, at√© o momento ainda n√£o recebemos o seu malote. Por gentileza, verificar e enviar o quanto antes!`;
            
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/55${whatsapp}?text=${encodedMessage}`;
            
            // Abre o WhatsApp Web/App automaticamente
            window.open(whatsappUrl, '_blank');
            
            console.log(`üì± WhatsApp enviado para ${filialCodigo} (${whatsapp})`);
            
            // Opcional: Mostra notifica√ß√£o se o usu√°rio estiver logado
            if (currentUser) {
                // Cria notifica√ß√£o visual no sistema
                showScheduledMessageNotification(filialCodigo);
            }
        }
        
        function showScheduledMessageNotification(filialCodigo) {
            // Cria elemento de notifica√ß√£o
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white p-4 rounded-lg shadow-lg z-50 max-w-sm';
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fab fa-whatsapp text-xl mr-3"></i>
                    <div>
                        <div class="font-bold">WhatsApp Autom√°tico Enviado</div>
                        <div class="text-sm opacity-90">Para: ${filialCodigo}</div>
                        <div class="text-xs opacity-75">${new Date().toLocaleTimeString('pt-BR')}</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Remove ap√≥s 5 segundos
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 5000);
        }

        // Fun√ß√µes de Administra√ß√£o - Gerenciar Usu√°rios
        async function loadUsuariosData() {
            try {
                const users = await window.firebaseDB.getUsers();
                const table = document.getElementById('usuariosTable');
                table.innerHTML = '';
                
                users.forEach(user => {
                    const row = table.insertRow();
                    const isAdmin = normalizeText(user.email) === normalizeText('R');
                    const userType = isAdmin ? 'Administrador' : 'Usu√°rio';
                    const typeClass = isAdmin ? 'text-red-700 bg-red-50' : 'text-blue-700 bg-blue-50';
                    
                    row.innerHTML = `
                        <td class="border border-gray-300 px-4 py-3">${user.name}</td>
                        <td class="border border-gray-300 px-4 py-3">${user.email}</td>
                        <td class="border border-gray-300 px-4 py-3">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${typeClass}">
                                ${isAdmin ? '<i class="fas fa-crown mr-1"></i>' : '<i class="fas fa-user mr-1"></i>'}${userType}
                            </span>
                        </td>
                        <td class="border border-gray-300 px-4 py-3">
                            ${!isAdmin ? `
                                <button onclick="deleteUser('${user.id}')" 
                                        class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition text-sm">
                                    <i class="fas fa-trash mr-1"></i>Excluir
                                </button>
                            ` : '<span class="text-gray-500 text-sm">Protegido</span>'}
                        </td>
                    `;
                });
                
            } catch (error) {
                console.error('Erro ao carregar usu√°rios:', error);
                alert('Erro ao carregar usu√°rios. Tente novamente.');
            }
        }
        
        async function addNewUser() {
            const name = document.getElementById('newUserName').value.trim();
            const email = document.getElementById('newUserEmail').value.trim();
            const password = document.getElementById('newUserPassword').value.trim();
            
            if (!name || !email || !password) {
                alert('Por favor, preencha todos os campos obrigat√≥rios');
                return;
            }
            
            try {
                const users = await window.firebaseDB.getUsers();
                if (users.find(u => normalizeText(u.email) === normalizeText(email))) {
                    alert('Este email/login j√° est√° cadastrado');
                    return;
                }
                
                const success = await window.firebaseDB.addUser({ name, email, password });
                
                if (success) {
                    alert('‚úÖ Usu√°rio adicionado com sucesso!');
                    document.getElementById('newUserName').value = '';
                    document.getElementById('newUserEmail').value = '';
                    document.getElementById('newUserPassword').value = '';
                    loadUsuariosData();
                } else {
                    alert('‚ùå Erro ao adicionar usu√°rio. Tente novamente.');
                }
            } catch (error) {
                console.error('Erro ao adicionar usu√°rio:', error);
                alert('‚ùå Erro ao adicionar usu√°rio. Tente novamente.');
            }
        }
        
        async function deleteUser(userId) {
            if (!confirm('‚ö†Ô∏è Tem certeza que deseja excluir este usu√°rio? Esta a√ß√£o n√£o pode ser desfeita.')) {
                return;
            }
            
            try {
                // Nota: Firebase Firestore n√£o tem fun√ß√£o de delete direta no cliente
                // Por seguran√ßa, apenas mostra mensagem
                alert('‚ö†Ô∏è Funcionalidade de exclus√£o deve ser implementada no backend por seguran√ßa.');
                
                // Em um ambiente real, voc√™ faria uma chamada para uma Cloud Function
                // que verificaria permiss√µes e excluiria o usu√°rio
                
            } catch (error) {
                console.error('Erro ao excluir usu√°rio:', error);
                alert('‚ùå Erro ao excluir usu√°rio. Tente novamente.');
            }
        }
        
        // Fun√ß√µes de Administra√ß√£o - Configurar WhatsApp
        let filteredWhatsAppFiliais = [];
        
        async function loadWhatsAppConfigData() {
            try {
                // Carrega dados das filiais para configura√ß√£o de WhatsApp
                filteredWhatsAppFiliais = [...filiais];
                updateWhatsAppConfigDisplay();
            } catch (error) {
                console.error('Erro ao carregar configura√ß√µes de WhatsApp:', error);
                alert('Erro ao carregar configura√ß√µes. Tente novamente.');
            }
        }
        
        function filterWhatsAppFiliais() {
            const searchText = normalizeText(document.getElementById('searchWhatsAppFilial').value);
            const tipoFilter = document.getElementById('whatsappTipoFilter').value;
            
            filteredWhatsAppFiliais = filiais.filter(filial => {
                // Filtro por busca de texto
                if (searchText && !normalizeText(filial.codigo).includes(searchText)) return false;
                
                // Filtro por tipo
                if (tipoFilter && filial.tipo !== tipoFilter) return false;
                
                return true;
            });
            
            updateWhatsAppConfigDisplay();
        }
        
        function updateWhatsAppConfigDisplay() {
            const table = document.getElementById('whatsappConfigTable');
            table.innerHTML = '';
            
            if (filteredWhatsAppFiliais.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="5" class="border border-gray-300 px-4 py-8 text-center text-gray-500">
                            <i class="fas fa-search text-4xl mb-4 block"></i>
                            <p class="text-lg font-medium">Nenhuma filial encontrada</p>
                            <p class="text-sm">Tente ajustar os filtros para ver mais resultados</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredWhatsAppFiliais.forEach((filial, index) => {
                const row = table.insertRow();
                
                // Tipo com cor
                const tipoClass = filial.tipo === 'cargas' ? 'text-blue-700 bg-blue-50' : 'text-orange-700 bg-orange-50';
                const tipoIcon = filial.tipo === 'cargas' ? '<i class="fas fa-truck mr-1"></i>' : '<i class="fas fa-users mr-1"></i>';
                
                row.innerHTML = `
                    <td class="border border-gray-300 px-4 py-3">
                        <div class="font-medium text-gray-900">${filial.codigo}</div>
                    </td>
                    <td class="border border-gray-300 px-4 py-3">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${tipoClass}">
                            ${tipoIcon}${filial.tipo.charAt(0).toUpperCase() + filial.tipo.slice(1)}
                        </span>
                    </td>
                    <td class="border border-gray-300 px-4 py-3">
                        <span class="text-sm ${filial.whatsapp ? 'text-green-600' : 'text-gray-500'}">${filial.whatsapp || 'N√£o configurado'}</span>
                    </td>
                    <td class="border border-gray-300 px-4 py-3">
                        <input type="text" id="newWhatsApp_${index}" placeholder="Ex: 67999999999" 
                               value="${filial.whatsapp || ''}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm">
                    </td>
                    <td class="border border-gray-300 px-4 py-3 text-center">
                        <button onclick="updateWhatsApp(${index})" 
                                class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition text-sm">
                            <i class="fas fa-save mr-1"></i>Salvar
                        </button>
                    </td>
                `;
            });
        }
        
        function updateWhatsApp(index) {
            const filial = filteredWhatsAppFiliais[index];
            const newWhatsApp = document.getElementById(`newWhatsApp_${index}`).value.trim();
            
            // Valida√ß√£o b√°sica do n√∫mero
            if (newWhatsApp && !/^\d{10,11}$/.test(newWhatsApp)) {
                alert('‚ö†Ô∏è Por favor, insira um n√∫mero v√°lido (apenas n√∫meros, 10 ou 11 d√≠gitos)');
                return;
            }
            
            // Encontra a filial no array principal e atualiza
            const filialIndex = filiais.findIndex(f => f.codigo === filial.codigo);
            if (filialIndex !== -1) {
                filiais[filialIndex].whatsapp = newWhatsApp;
                
                // Atualiza tamb√©m no array filtrado
                filteredWhatsAppFiliais[index].whatsapp = newWhatsApp;
                
                // Salva no localStorage para persistir as altera√ß√µes
                localStorage.setItem('filiaisWhatsApp', JSON.stringify(filiais));
                
                alert(`‚úÖ WhatsApp da filial ${filial.codigo} atualizado com sucesso!`);
                updateWhatsAppConfigDisplay();
            } else {
                alert('‚ùå Erro ao encontrar filial. Tente novamente.');
            }
        }
        
        // Carrega configura√ß√µes de WhatsApp do localStorage na inicializa√ß√£o
        function loadWhatsAppFromStorage() {
            try {
                const savedFiliais = localStorage.getItem('filiaisWhatsApp');
                if (savedFiliais) {
                    const parsedFiliais = JSON.parse(savedFiliais);
                    // Atualiza apenas os n√∫meros de WhatsApp, mantendo a estrutura original
                    parsedFiliais.forEach(savedFilial => {
                        const filialIndex = filiais.findIndex(f => f.codigo === savedFilial.codigo);
                        if (filialIndex !== -1) {
                            filiais[filialIndex].whatsapp = savedFilial.whatsapp;
                        }
                    });
                    console.log('üì± Configura√ß√µes de WhatsApp carregadas do localStorage');
                }
            } catch (error) {
                console.error('Erro ao carregar configura√ß√µes de WhatsApp:', error);
            }
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            // Carrega configura√ß√µes de WhatsApp salvas
            loadWhatsAppFromStorage();
            
            showLogin();
            
            // Configura datas padr√£o para relat√≥rios
            const today = new Date();
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            
            document.getElementById('reportStartDate').value = startOfMonth.toISOString().split('T')[0];
            document.getElementById('reportEndDate').value = today.toISOString().split('T')[0];
            
            // Carrega op√ß√µes de filiais para relat√≥rios
            const reportFilialSelect = document.getElementById('reportFilialFilter');
            reportFilialSelect.innerHTML = '<option value="">Todas as filiais</option>';
            filiais.forEach(filial => {
                const option = document.createElement('option');
                option.value = filial.codigo;
                option.textContent = filial.codigo;
                reportFilialSelect.appendChild(option);
            });
            
            // Inicia sistema de agendamento autom√°tico
            scheduleWhatsAppMessages();
            
            console.log('üöÄ Sistema de agendamento de WhatsApp iniciado!');
            console.log('üì± √Ågua Clara-02 ser√° verificada diariamente √†s 04:08');
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97221cba401eaf70',t:'MTc1NTY5NTIzMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
